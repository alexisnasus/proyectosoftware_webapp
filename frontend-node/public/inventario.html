<!-- frontend-node/public/inventario.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario ‚Äì ManuMarket</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      /* Animaciones personalizadas */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      /* Gradiente personalizado */
      .bg-gradient-custom {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e40af 100%);
      }
      
      /* Efectos de vidrio */
      .glass-effect {
        backdrop-filter: blur(16px);
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
      
      .glass-card {
        backdrop-filter: blur(8px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
      }
      
      .animate-slide-in {
        animation: slideIn 0.5s ease-out;
      }
      
      /* Estilos del modal moderno */
      .modal-overlay {
        backdrop-filter: blur(10px);
        background: linear-gradient(135deg, rgba(15,23,42,0.85) 0%, rgba(30,41,59,0.85) 100%);
      }
      
      .modal-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.98) 100%);
        border: 1.5px solid rgba(59,130,246,0.25);
        border-radius: 1.25rem;
        box-shadow: 0 8px 40px 0 #1e293bcc, 0 1.5px 0 #3b82f6;
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        min-width: 280px;
        max-width: 24rem;
        animation: fadeIn 0.7s cubic-bezier(.4,2,.6,1) 1;
        position: relative;
      }
      
      .modal-success-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.2rem;
      }
      
      .modal-success-icon svg, .modal-success-icon i {
        animation: popIn 0.5s cubic-bezier(.4,2,.6,1);
      }
      
      @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        80% { transform: scale(1.15); opacity: 1; }
        100% { transform: scale(1); }
      }
      
      .modal-title {
        color: #fff;
        font-size: 1.45rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
        letter-spacing: 0.01em;
      }
      
      .modal-close {
        position: absolute;
        top: 1.1rem;
        right: 1.1rem;
        color: #64748b;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }
      
      .modal-close:hover {
        color: #fff;
      }
      
      .modal-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.85rem 0;
        background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
        color: #fff;
        font-weight: 600;
        font-size: 1.08rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 12px #1e40af55;
        border: 1.5px solid #3b82f6cc;
        transition: background 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      
      .modal-btn:hover {
        background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
        box-shadow: 0 4px 24px #1e40af88;
      }
      
      /* Estilos espec√≠ficos para el modal de confirmaci√≥n */
      .modal-btn-danger {
        background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
        border-color: #ef4444cc;
        box-shadow: 0 2px 12px #dc262655;
      }
      
      .modal-btn-danger:hover {
        background: linear-gradient(90deg, #b91c1c 0%, #dc2626 100%);
        box-shadow: 0 4px 24px #dc262688;
      }
      
      .modal-btn-secondary {
        background: linear-gradient(90deg, #64748b 0%, #94a3b8 100%);
        border-color: #64748bcc;
        box-shadow: 0 2px 12px #64748b55;
      }
      
      .modal-btn-secondary:hover {
        background: linear-gradient(90deg, #475569 0%, #64748b 100%);
        box-shadow: 0 4px 24px #64748b88;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-custom">
    <!-- Verificaci√≥n de acceso -->
    <div id="accessDenied" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4">
        <div class="text-center">
          <i data-lucide="shield-x" class="mx-auto h-12 w-12 text-red-500 mb-4"></i>
          <h3 class="mt-4 text-lg font-medium text-gray-900">Acceso Denegado</h3>
          <p class="mt-2 text-sm text-gray-500">
            No tienes permisos para acceder al inventario. Solo los administradores pueden gestionar el inventario.
          </p>
          <div class="mt-6">
            <a href="/dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg inline-flex items-center gap-2">
              <i data-lucide="arrow-left" class="w-4 h-4"></i>
              Volver al Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

        <!-- Barra de navegaci√≥n moderna -->
    <nav class="glass-effect border-b border-white/10 animate-slide-in">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <!-- Logo y brand -->
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 bg-blue-600 p-3 rounded-xl shadow-lg">
              <img src="/ManuLogo_WIP.png" alt="ManuMarket" class="w-7 h-7 object-contain">
            </div>
            <div>
              <h1 class="text-2xl font-bold text-white">ManuMarket</h1>
              <p class="text-sm text-slate-300">Gesti√≥n de Inventario</p>
            </div>
          </div>

          <!-- Navigation Links Desktop -->
          <div id="navigationLinks" class="hidden md:flex md:space-x-2">
            <a href="/dashboard" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a id="inventarioLink" href="/inventario" class="inline-flex items-center px-5 py-3 rounded-xl bg-blue-600/30 text-white font-semibold text-base border border-blue-500/50 space-x-2 shadow-lg">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>Inventario</span>
            </a>
            <a href="/pos" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="shopping-bag" class="w-5 h-5"></i>
              <span>POS</span>
            </a>
            <a href="/historial-ventas" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="history" class="w-5 h-5"></i>
              <span>Historial</span>
            </a>
            <a id="trabajadoresLink" href="/trabajadores" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Trabajadores</span>
            </a>
          </div>

          <!-- User info y logout -->
          <div class="flex items-center space-x-5">
            <div class="text-right hidden sm:block">
              <p id="userInfo" class="text-base font-bold text-white">‚Äî</p>
              <p class="text-sm text-slate-200">Bienvenido</p>
            </div>
            <a href="/logout" class="inline-flex items-center px-5 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base transition-all duration-200 space-x-2 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Salir</span>
            </a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button id="btnMenuInv" class="inline-flex items-center justify-center p-3 rounded-xl text-white hover:text-white hover:bg-white/20 transition-all duration-200">
              <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="menuResponsiveInv" class="md:hidden hidden border-t border-white/10 bg-slate-900/50">
        <div class="px-4 pt-2 pb-3 space-y-1">
          <a href="/dashboard" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
          <a id="inventarioLinkMobile" href="/inventario" class="flex items-center px-4 py-3 rounded-xl bg-blue-600/30 text-white font-bold text-base space-x-3 border border-blue-500/50 shadow-lg">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span>Inventario</span>
          </a>
          <a href="/pos" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span>POS</span>
          </a>
          <a href="/historial-ventas" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="history" class="w-5 h-5"></i>
            <span>Historial de Ventas</span>
          </a>
          <a id="trabajadoresLinkMobile" href="/trabajadores" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span>Trabajadores</span>
          </a>
          <div class="border-t border-white/10 pt-3 mt-3">
            <div class="px-4 py-2">
              <p id="userInfoMobile" class="text-base font-bold text-white">‚Äî</p>
            </div>
            <a href="/logout" class="flex items-center px-4 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base space-x-3 transition-all duration-200 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span>Cerrar sesi√≥n</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <script>
      const btnMenuInv = document.getElementById("btnMenuInv");
      const menuResponsiveInv = document.getElementById("menuResponsiveInv");
      btnMenuInv && btnMenuInv.addEventListener("click", () => {
        menuResponsiveInv.classList.toggle("hidden");
      });
      
      // Inicializar iconos
      lucide.createIcons();
    </script>

    <!-- CONTENIDO: LISTADO DE PRODUCTOS -->
    <main class="max-w-7xl mx-auto p-6 animate-fade-in">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
        <div class="flex items-center gap-3">
          <i data-lucide="package" class="w-8 h-8 text-white"></i>
          <h1 class="text-2xl font-semibold text-white">Inventario</h1>
        </div>
      </div>

        <div class="flex justify-end space-x-2 w-full sm:w-auto mb-4">
          <div class="relative w-64">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-white/70"></i>
            <input
              id="searchInput"
              type="text"
              placeholder="Buscar producto..."
              class="pl-10 flex-1 border border-white/20 bg-white/10 text-white placeholder-white/70 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full backdrop-blur-sm"
            />
          </div>
          <!-- Bot√≥n Importar (azul) -->
          <button
            id="btnImportar"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center gap-2"
            title="Importar productos nuevos desde CSV (no actualiza existentes)"
          >
            <i data-lucide="upload" class="w-4 h-4"></i>
            Importar
          </button>
          <!-- Bot√≥n Actualizar (naranja) -->
          <button
            id="btnActualizar"
            class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 flex items-center gap-2"
            title="Actualizar inventario desde CSV (crea nuevos y actualiza existentes)"
          >
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Actualizar
          </button>
          <!-- Bot√≥n Exportar (morado) -->
          <button
            id="btnExportar"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 flex items-center gap-2"
          >
            <i data-lucide="download" class="w-4 h-4"></i>
            Exportar
          </button>
          <!-- Bot√≥n Nuevo Producto (verde) -->
          <button
            id="btnNuevoProducto"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center gap-2"
          >
            <i data-lucide="plus" class="w-4 h-4"></i>
            Nuevo Producto
          </button>
        </div>
      </div>

      <div class="glass-card rounded-2xl overflow-auto">
        <table class="min-w-full divide-y divide-white">
          <thead class="bg-white backdrop-blur-sm">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center gap-1">
                  <i data-lucide="hash" class="w-3 h-3"></i>
                  ID
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center gap-1">
                  <i data-lucide="qr-code" class="w-3 h-3"></i>
                  C√≥digo de Barra
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none w-80 max-w-80" 
                  onclick="ordenarTabla('nombre')" title="Clic para ordenar por nombre">
                <div class="flex items-center gap-1">
                  <i data-lucide="tag" class="w-3 h-3"></i>
                  Nombre <span id="sort-nombre" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" 
                  onclick="ordenarTabla('precio')" title="Clic para ordenar por precio">
                <div class="flex items-center gap-1">
                  <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                  Precio <span id="sort-precio" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" 
                  onclick="ordenarTabla('stock')" title="Clic para ordenar por stock">
                <div class="flex items-center gap-1">
                  <i data-lucide="package-2" class="w-3 h-3"></i>
                  Stock <span id="sort-stock" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center justify-center gap-1">
                  <i data-lucide="settings" class="w-3 h-3"></i>
                  Acciones
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="tbodyInventario" class="bg-white divide-y divide-white">
            <!-- JS inyectar√° aqu√≠ las filas -->
          </tbody>
        </table>
      </div>
    </main>

    <!-- Inputs ocultos para importar CSV -->
    <input type="file" id="inputImportarCSV" accept=".csv" class="hidden" />
    <input type="file" id="inputActualizarCSV" accept=".csv" class="hidden" />

    <!-- Modal HTML para crear/editar producto con dise√±o moderno -->
    <div id="modalProducto" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay hidden">
      <div class="modal-card animate-fade-in max-w-sm w-full mx-4">
        <button id="btnCerrarModal" class="modal-close" aria-label="Cerrar">&times;</button>
        
        <!-- √çcono del modal -->
        <div class="modal-success-icon">
          <i id="modalIcon" data-lucide="package-plus" class="w-12 h-12 text-blue-400" style="filter: drop-shadow(0 0 16px rgba(59, 130, 246, 0.5));"></i>
        </div>
        
        <!-- T√≠tulo -->
        <h2 id="modalTitle" class="modal-title mb-6">Nuevo Producto</h2>
        
        <form id="formProducto" class="space-y-5">
          <!-- C√≥digo de Barra -->
          <div>
            <label for="codigoProd" class="block text-sm font-medium text-white/80 mb-2 flex items-center gap-2">
              <i data-lucide="qr-code" class="w-4 h-4 text-blue-400"></i>
              C√≥digo de Barra
            </label>
            <input
              id="codigoProd"
              type="text"
              class="w-full glass-card border border-white/30 px-4 py-3 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200"
              placeholder="Ingresa el c√≥digo de barra"
            />
          </div>
          
          <!-- Nombre -->
          <div>
            <label for="nombreProd" class="block text-sm font-medium text-white/80 mb-2 flex items-center gap-2">
              <i data-lucide="tag" class="w-4 h-4 text-blue-400"></i>
              Nombre del Producto 
              <span class="text-red-400">*</span>
            </label>
            <input
              id="nombreProd"
              type="text"
              required
              class="w-full glass-card border border-white/30 px-4 py-3 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200"
              placeholder="Nombre descriptivo del producto"
            />
          </div>
          
          <!-- Precio -->
          <div>
            <label for="precioProd" class="block text-sm font-medium text-white/80 mb-2 flex items-center gap-2">
              <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-400"></i>
              Precio (CLP)
            </label>
            <input
              id="precioProd"
              type="number"
              step="10"
              min="0"
              class="w-full glass-card border border-white/30 px-4 py-3 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200"
              placeholder="0"
            />
          </div>
          
          <!-- Stock -->
          <div>
            <label for="stockProd" class="block text-sm font-medium text-white/80 mb-2 flex items-center gap-2">
              <i data-lucide="package-2" class="w-4 h-4 text-blue-400"></i>
              Cantidad en Stock
            </label>
            <input
              id="stockProd"
              type="number"
              min="0"
              class="w-full glass-card border border-white/30 px-4 py-3 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200"
              placeholder="0"
            />
          </div>
          
          <!-- Botones de acci√≥n -->
          <div class="flex gap-3 pt-4">
            <button type="button" id="btnCancelarModal" class="flex-1 modal-btn bg-slate-600 hover:bg-slate-700">
              <i data-lucide="x" class="w-5 h-5"></i>
              <span>Cancelar</span>
            </button>
            <button type="submit" class="flex-1 modal-btn bg-green-600 hover:bg-green-700">
              <i data-lucide="save" class="w-5 h-5"></i>
              <span>Guardar</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar producto -->
    <div id="modalConfirmarEliminar" class="fixed inset-0 flex items-center justify-center z-50 modal-overlay hidden">
      <div class="modal-card animate-fade-in max-w-sm w-full mx-4">
        <button id="btnCerrarModalEliminar" class="modal-close" aria-label="Cerrar">&times;</button>
        
        <!-- √çcono de advertencia -->
        <div class="modal-success-icon">
          <i data-lucide="alert-triangle" class="w-12 h-12 text-red-400" style="filter: drop-shadow(0 0 16px rgba(239, 68, 68, 0.5));"></i>
        </div>
        
        <!-- T√≠tulo -->
        <h2 class="modal-title mb-4">Confirmar Eliminaci√≥n</h2>
        
        <!-- Mensaje -->
        <div class="text-center mb-6">
          <p class="text-white/90 text-sm leading-relaxed">
            ¬øEliminar este producto del inventario?
          </p>
          <p class="text-white/70 text-xs mt-2">
            (Se mantendr√° en el historial de ventas)
          </p>
          <div id="productoAEliminar" class="mt-4 p-3 glass-card rounded-lg">
            <p class="text-white font-medium text-sm" id="nombreProductoEliminar">‚Äî</p>
            <p class="text-white/70 text-xs" id="codigoProductoEliminar">‚Äî</p>
          </div>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div class="flex gap-3">
          <button type="button" id="btnCancelarEliminar" class="flex-1 modal-btn modal-btn-secondary">
            <i data-lucide="x" class="w-5 h-5"></i>
            <span>Cancelar</span>
          </button>
          <button type="button" id="btnConfirmarEliminar" class="flex-1 modal-btn modal-btn-danger">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
            <span>Eliminar</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      // BASE URL de tu API Django (ventas_api)
      const BACKEND_URL = "http://localhost:8000";
      const token = localStorage.getItem("token");
      // Agrega el header Authorization si hay token
      const headers = token
        ? { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }
        : { "Content-Type": "application/json" };

      const tbodyInventario = document.getElementById("tbodyInventario");
      const btnNuevoProducto = document.getElementById("btnNuevoProducto");
      const modalProducto = document.getElementById("modalProducto");
      const formProducto = document.getElementById("formProducto");
      const modalTitle = document.getElementById("modalTitle");
      const btnCerrarModal = document.getElementById("btnCerrarModal");
      const btnCancelarModal = document.getElementById("btnCancelarModal");
      const btnImportar = document.getElementById("btnImportar");
      const btnActualizar = document.getElementById("btnActualizar");
      const btnExportar = document.getElementById("btnExportar");
      const inputImportarCSV = document.getElementById("inputImportarCSV");
      const inputActualizarCSV = document.getElementById("inputActualizarCSV");
      const searchInput = document.getElementById("searchInput");

      // Modal de confirmaci√≥n de eliminaci√≥n
      const modalConfirmarEliminar = document.getElementById("modalConfirmarEliminar");
      const btnCerrarModalEliminar = document.getElementById("btnCerrarModalEliminar");
      const btnCancelarEliminar = document.getElementById("btnCancelarEliminar");
      const btnConfirmarEliminar = document.getElementById("btnConfirmarEliminar");
      const nombreProductoEliminar = document.getElementById("nombreProductoEliminar");
      const codigoProductoEliminar = document.getElementById("codigoProductoEliminar");

      // Funci√≥n para cerrar modal de eliminaci√≥n
      function cerrarConfirmEliminar() {
        modalConfirmarEliminar.classList.add("hidden");
        eliminarProductoId = null;
      }

      let editandoProductoId = null;
      let eliminarProductoId = null;

      // Funci√≥n para mostrar notificaciones toast
      function showToast(message, type = 'success') {
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.className = `fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Funci√≥n para mostrar modal de error personalizado
      function showErrorModal(title, message, details = null) {
        return new Promise((resolve) => {
          // Crear overlay del modal
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
          
          // Crear contenido del modal
          overlay.innerHTML = `
            <div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4 border border-red-400/30 shadow-2xl animate-fade-in">
              <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i data-lucide="x-circle" class="w-8 h-8 text-red-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">${title}</h3>
                <p class="text-slate-300 text-sm">${message}</p>
              </div>
              
              ${details ? `
              <div class="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-600/30">
                <h4 class="text-white font-semibold mb-2 text-sm">Detalles del error:</h4>
                <p class="text-slate-300 text-xs font-mono break-words">${details}</p>
              </div>
              ` : ''}
              
              <button id="closeError" class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium transition-colors">
                Entendido
              </button>
            </div>
          `;
          
          document.body.appendChild(overlay);
          
          // Inicializar iconos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          
          // Event listeners
          overlay.querySelector('#closeError').addEventListener('click', () => {
            document.body.removeChild(overlay);
            resolve();
          });
          
          // Cerrar con clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
              resolve();
            }
          });
        });
      }

      // Funci√≥n para mostrar modal de informaci√≥n personalizado
      function showInfoModal(title, message, type = 'info') {
        return new Promise((resolve) => {
          const colorMap = {
            info: { bg: 'bg-blue-500/20', text: 'text-blue-400', btn: 'bg-blue-600 hover:bg-blue-700', icon: 'info' },
            warning: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', btn: 'bg-yellow-600 hover:bg-yellow-700', icon: 'alert-triangle' },
            success: { bg: 'bg-green-500/20', text: 'text-green-400', btn: 'bg-green-600 hover:bg-green-700', icon: 'check-circle' }
          };
          
          const colors = colorMap[type] || colorMap.info;
          
          // Crear overlay del modal
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
          
          // Crear contenido del modal
          overlay.innerHTML = `
            <div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4 border border-blue-400/30 shadow-2xl animate-fade-in">
              <div class="text-center mb-6">
                <div class="w-16 h-16 ${colors.bg} rounded-full flex items-center justify-center mx-auto mb-4">
                  <i data-lucide="${colors.icon}" class="w-8 h-8 ${colors.text}"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">${title}</h3>
                <p class="text-slate-300 text-sm">${message}</p>
              </div>
              
              <button id="closeInfo" class="w-full px-4 py-3 ${colors.btn} text-white rounded-xl font-medium transition-colors">
                Entendido
              </button>
            </div>
          `;
          
          document.body.appendChild(overlay);
          
          // Inicializar iconos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          
          // Event listeners
          overlay.querySelector('#closeInfo').addEventListener('click', () => {
            document.body.removeChild(overlay);
            resolve();
          });
          
          // Cerrar con clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
              resolve();
            }
          });
        });
      }

      // Funci√≥n para comprimir datos con base64 y gzip (si est√° disponible)
      async function comprimirDatos(jsonString) {
        try {
          // Usar solo base64 para mayor compatibilidad
          // El uso de unescape/encodeURIComponent maneja caracteres especiales
          return btoa(unescape(encodeURIComponent(jsonString)));
        } catch (error) {
          console.warn('Error en compresi√≥n base64:', error);
          return jsonString; // Fallback a texto plano
        }
      }
      
      // Funci√≥n optimizada para archivos grandes
      async function procesarCSVOptimizado(file, esActualizacion = false) {
        if (!file) return;

        try {
          // Validar tama√±o del archivo
          const maxSize = 50 * 1024 * 1024; // 50MB
          if (file.size > maxSize) {
            await showErrorModal("Archivo muy grande", "El archivo supera el tama√±o m√°ximo permitido de 50MB.");
            return;
          }

          const text = await file.text();
          const lines = text.trim().split("\n");
          
          if (lines.length <= 1) {
            await showInfoModal("Archivo vac√≠o", "El archivo CSV est√° vac√≠o o solo contiene cabeceras.", "warning");
            return;
          }

          lines.shift(); // quitar cabecera
          
          // Procesar en chunks para archivos grandes
          const chunkSize = 500; // 500 productos por chunk
          const totalProductos = lines.length;
          const totalChunks = Math.ceil(totalProductos / chunkSize);
          
          if (totalProductos > chunkSize) {
            const shouldContinue = await showCSVConfirmModal(totalProductos, totalChunks, chunkSize);
            if (!shouldContinue) {
              return;
            }
          }

          // Bot√≥n loading
          const btn = esActualizacion ? btnActualizar : btnImportar;
          const textoOriginal = btn.innerHTML;
          
          let productosCreados = 0;
          let productosActualizados = 0;
          let errores = 0;

          // Procesar chunks secuencialmente
          for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, totalProductos);
            const chunk = lines.slice(start, end);
            
            // Actualizar progreso
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Procesando ${i + 1}/${totalChunks} (${Math.round(((i + 1) / totalChunks) * 100)}%)`;
            btn.disabled = true;
            
            // Reinicializar √≠conos
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            
            const productos = [];
            
            // Procesar chunk actual
            for (const line of chunk) {
              const values = line.split(",").map(v => v.replace(/^"|"$/g, "").trim());
              const codigo = values[1];
              const nombre = values[2];
              let precioRaw = values[3] || "";

              if (precioRaw.toLowerCase() === "null" || precioRaw === "") {
                precioRaw = "0";
              }
              let precio = parseInt(precioRaw, 10);
              if (isNaN(precio)) precio = 0;

              if (!codigo) continue;

              productos.push({
                codigo: codigo,
                nombre: nombre || "",
                precio: precio
              });
            }

            if (productos.length === 0) continue;

            // VERSI√ìN COMPRIMIDA: Convertir a base64 comprimido
            const jsonString = JSON.stringify(productos);
            const compressed = await comprimirDatos(jsonString);
            
            // Enviar chunk al backend
            const endpoint = esActualizacion ? 'bulk-update' : 'bulk-import';
            
            try {
              const response = await fetch(`${BACKEND_URL}/ventas/productos/${endpoint}/`, {
                method: "POST",
                headers: {
                  ...headers
                },
                body: JSON.stringify({ 
                  productos_compressed: compressed,
                  chunk_info: {
                    current: i + 1,
                    total: totalChunks,
                    productos_en_chunk: productos.length
                  }
                })
              });

              if (!response.ok) {
                console.error(`Error HTTP ${response.status}:`, response.statusText);
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
              }

              const result = await response.json();

              if (response.ok) {
                productosCreados += result.productos_creados || 0;
                productosActualizados += result.productos_actualizados || 0;
                errores += result.errores || 0;
              } else {
                console.error(`Error en chunk ${i + 1}:`, result);
                errores += productos.length;
              }

            } catch (fetchError) {
              console.error(`Error de red en chunk ${i + 1}:`, fetchError);
              
              // Si es un error de red, intentar una vez m√°s con datos sin comprimir
              if (fetchError.message.includes('NetworkError') || fetchError.message.includes('fetch')) {
                console.log(`Reintentando chunk ${i + 1} sin compresi√≥n...`);
                try {
                  const response = await fetch(`${BACKEND_URL}/ventas/productos/${endpoint}/`, {
                    method: "POST",
                    headers: {
                      ...headers
                    },
                    body: JSON.stringify({ 
                      productos: productos,
                      chunk_info: {
                        current: i + 1,
                        total: totalChunks,
                        productos_en_chunk: productos.length
                      }
                    })
                  });

                  if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                  }

                  const result = await response.json();
                  productosCreados += result.productos_creados || 0;
                  productosActualizados += result.productos_actualizados || 0;
                  errores += result.errores || 0;
                  
                  console.log(`‚úÖ Chunk ${i + 1} procesado sin compresi√≥n`);
                } catch (retryError) {
                  console.error(`Error en reintento de chunk ${i + 1}:`, retryError);
                  errores += productos.length;
                }
              } else {
                errores += productos.length;
              }
            }

            // Peque√±a pausa para no saturar el servidor
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          // Mostrar resultado final con modal personalizado
          await showCSVResultModal(totalProductos, productosCreados, productosActualizados, errores, totalChunks, esActualizacion);
          cargarInventario();

        } catch (error) {
          console.error("Error completo al procesar CSV:", {
            error: error,
            message: error.message,
            stack: error.stack,
            backendUrl: BACKEND_URL,
            token: token ? "presente" : "ausente"
          });
          
          // Mostrar error m√°s espec√≠fico al usuario
          let errorTitle = "Error al procesar archivo";
          let errorMsg = "";
          if (error.message.includes('NetworkError')) {
            errorMsg = "No se puede conectar al servidor. Verifique que el servidor backend est√© ejecut√°ndose y que no haya problemas de red.";
          } else if (error.message.includes('401')) {
            errorMsg = "Token de autenticaci√≥n expirado. Inicie sesi√≥n nuevamente.";
          } else if (error.message.includes('403')) {
            errorMsg = "No tiene permisos para realizar esta operaci√≥n.";
          } else {
            errorMsg = error.message;
          }
          
          await showErrorModal(errorTitle, errorMsg, error.stack);
        } finally {
          // Restaurar bot√≥n
          const btn = esActualizacion ? btnActualizar : btnImportar;
          const textoOriginal = esActualizacion ? 
            `<i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualizar` : 
            `<i data-lucide="upload" class="w-4 h-4"></i> Importar`;
          btn.innerHTML = textoOriginal;
          btn.disabled = false;
          
          // Reinicializar √≠conos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }
      }

      // Funci√≥n para mostrar modal de confirmaci√≥n de CSV personalizado
      function showCSVConfirmModal(totalProductos, totalChunks, chunkSize) {
        return new Promise((resolve) => {
          // Crear overlay del modal
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
          
          // Crear contenido del modal
          overlay.innerHTML = `
            <div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4 border border-blue-400/30 shadow-2xl animate-fade-in">
              <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Confirmar Procesamiento</h3>
                <p class="text-slate-300 text-sm">Se va a procesar un archivo CSV grande</p>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-600/30">
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Total de productos:</span>
                    <span class="text-white font-semibold">${totalProductos}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Productos por lote:</span>
                    <span class="text-white font-semibold">${chunkSize}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Total de lotes:</span>
                    <span class="text-white font-semibold">${totalChunks}</span>
                  </div>
                </div>
              </div>
              
              <div class="flex gap-3">
                <button id="cancelCSV" class="flex-1 px-4 py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-xl font-medium transition-colors">
                  Cancelar
                </button>
                <button id="confirmCSV" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
                  Continuar
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(overlay);
          
          // Inicializar iconos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          
          // Event listeners
          overlay.querySelector('#confirmCSV').addEventListener('click', () => {
            document.body.removeChild(overlay);
            resolve(true);
          });
          
          overlay.querySelector('#cancelCSV').addEventListener('click', () => {
            document.body.removeChild(overlay);
            resolve(false);
          });
          
          // Cerrar con clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
              resolve(false);
            }
          });
        });
      }

      // Funci√≥n para mostrar modal de resultado del procesamiento CSV
      function showCSVResultModal(totalProductos, productosCreados, productosActualizados, errores, totalChunks, esActualizacion) {
        return new Promise((resolve) => {
          // Crear overlay del modal
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm';
          
          const isSuccess = errores === 0;
          const iconColor = isSuccess ? 'text-green-400' : 'text-yellow-400';
          const iconBg = isSuccess ? 'bg-green-500/20' : 'bg-yellow-500/20';
          const icon = isSuccess ? 'check-circle' : 'alert-triangle';
          
          // Crear contenido del modal
          overlay.innerHTML = `
            <div class="glass-card rounded-2xl p-6 max-w-md w-full mx-4 border border-blue-400/30 shadow-2xl animate-fade-in">
              <div class="text-center mb-6">
                <div class="w-16 h-16 ${iconBg} rounded-full flex items-center justify-center mx-auto mb-4">
                  <i data-lucide="${icon}" class="w-8 h-8 ${iconColor}"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">‚úÖ Procesamiento Completado</h3>
                <p class="text-slate-300 text-sm">${isSuccess ? 'El archivo se proces√≥ exitosamente' : 'Procesamiento completado con algunos errores'}</p>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-600/30">
                <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                  <i data-lucide="bar-chart-3" class="w-4 h-4 text-blue-400"></i>
                  üìä Resumen del Procesamiento
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Total productos:</span>
                    <span class="text-white font-semibold">${totalProductos}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Productos creados:</span>
                    <span class="text-green-400 font-semibold">${productosCreados}</span>
                  </div>
                  ${esActualizacion ? `
                  <div class="flex justify-between">
                    <span class="text-slate-400">Productos actualizados:</span>
                    <span class="text-blue-400 font-semibold">${productosActualizados}</span>
                  </div>
                  ` : ''}
                  <div class="flex justify-between">
                    <span class="text-slate-400">Errores:</span>
                    <span class="${errores > 0 ? 'text-red-400' : 'text-green-400'} font-semibold">${errores}</span>
                  </div>
                  <div class="flex justify-between border-t border-slate-600/50 pt-2 mt-2">
                    <span class="text-slate-400">Procesado en:</span>
                    <span class="text-white font-semibold">${totalChunks} lotes</span>
                  </div>
                </div>
              </div>
              
              <button id="closeResult" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
                Entendido
              </button>
            </div>
          `;
          
          document.body.appendChild(overlay);
          
          // Inicializar iconos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          
          // Event listeners
          overlay.querySelector('#closeResult').addEventListener('click', () => {
            document.body.removeChild(overlay);
            resolve();
          });
          
          // Cerrar con clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
              resolve();
            }
          });
        });
      }

      // --- Exportar Inventario a CSV ---
      function exportarCSV() {
        const filas = [];
        // Cabecera con 4 columnas
        filas.push(["ID", "C√≥digo de Barra", "Nombre", "Precio"]);

        document.querySelectorAll("#tbodyInventario tr").forEach((tr) => {
          const cols = tr.querySelectorAll("td");
          const id = cols[0].textContent.trim();
          const codigo = cols[1].textContent.trim();
          const nombre = cols[2].textContent.trim();
          // Limpiar s√≠mbolos de moneda y puntos del precio (col[3])
          const precio = cols[3]
            .textContent
            .trim()
            .replace(/\$/g, "")
            .replace(/\./g, "")
            .replace(/\s/g, "");
          filas.push([id, codigo, nombre, precio]);
        });

        const csvContent = filas
          .map((r) => r.map((v) => `"${v.replace(/"/g, '""')}"`).join(","))
          .join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "inventario_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      btnExportar.addEventListener("click", exportarCSV);

      // Variables globales para ordenamiento y filtros
      let productosOriginales = [];
      let ordenActual = { campo: null, direccion: 'asc' };

      // --- Cargar lista de productos ---
      async function cargarInventario() {
        try {
          const res = await fetch(`${BACKEND_URL}/ventas/productos/`, {
            method: "GET",
            headers,
          });
          if (!res.ok) throw new Error("Error al cargar inventario");
          const productos = await res.json();
          
          // Guardar los productos originales
          productosOriginales = productos;
          
          // Si hay un ordenamiento activo, aplicarlo
          if (ordenActual.campo) {
            ordenarTabla(ordenActual.campo);
          } else {
            // Si no hay ordenamiento, renderizar normalmente
            renderizarTabla(productos);
          }

          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }

        } catch (err) {
          console.error(err);
          await showErrorModal("Error al cargar inventario", "No se pudo cargar la lista de productos desde el servidor.");
        }
      }

      // --- Renderizar tabla de productos ---
      function renderizarTabla(productos) {
        if (!productos || productos.length === 0) {
          tbodyInventario.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i data-lucide="package-x" class="w-12 h-12 mb-4 text-gray-400"></i>
                  <p class="text-lg font-medium">No hay productos en el inventario</p>
                  <p class="text-sm">Agrega productos usando el bot√≥n "Nuevo Producto"</p>
                </div>
              </td>
            </tr>
          `;
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          return;
        }

        tbodyInventario.innerHTML = productos
          .map((producto) => {
            // Manejar diferentes estructuras de datos del stock
            let stockCantidad = 0;
            if (producto.stock) {
              if (typeof producto.stock === 'object' && producto.stock.cantidad !== undefined) {
                stockCantidad = producto.stock.cantidad;
              } else if (typeof producto.stock === 'number') {
                stockCantidad = producto.stock;
              }
            }
            
            // Asegurar que stockCantidad sea un n√∫mero v√°lido
            stockCantidad = Number(stockCantidad) || 0;
            
            const stockClass = stockCantidad === 0 ? 'text-red-600 font-bold' : 
                             stockCantidad < 10 ? 'text-yellow-600 font-semibold' : 
                             'text-green-600 font-medium';
            
            return `
              <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${producto.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${producto.codigo || '‚Äî'}</td>
                <td class="px-6 py-4 text-sm font-bold text-gray-900 max-w-80 truncate" title="${producto.nombre}">${producto.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">$${producto.precio?.toLocaleString('es-CL') || '0'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${stockClass}">${stockCantidad}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <div class="flex items-center justify-center space-x-2">
                    <button
                      onclick="editarProducto(${producto.id})"
                      class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-150"
                      title="Editar producto"
                    >
                      <i data-lucide="edit-2" class="w-3 h-3 mr-1"></i>
                      Editar
                    </button>
                    <button
                      onclick="confirmarEliminarProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}', '${producto.codigo || ''}')"
                      class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-150"
                      title="Eliminar producto"
                    >
                      <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");

        // Reinicializar iconos de Lucide
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }

      // --- Funciones de ordenamiento ---
      function ordenarTabla(campo) {
        if (ordenActual.campo === campo) {
          ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
          ordenActual.campo = campo;
          ordenActual.direccion = 'asc';
        }

        // Actualizar indicadores visuales
        document.querySelectorAll('[id^="sort-"]').forEach(el => {
          el.textContent = '‚Üï';
          el.className = 'ml-1 text-gray-400';
        });

        const indicator = document.getElementById(`sort-${campo}`);
        if (indicator) {
          indicator.textContent = ordenActual.direccion === 'asc' ? '‚Üë' : '‚Üì';
          indicator.className = 'ml-1 text-blue-600';
        }

        // Crear copia de productos para ordenar
        const productosOrdenados = [...productosOriginales].sort((a, b) => {
          let valorA, valorB;

          switch (campo) {
            case 'nombre':
              valorA = a.nombre?.toLowerCase() || '';
              valorB = b.nombre?.toLowerCase() || '';
              break;
            case 'precio':
              valorA = a.precio || 0;
              valorB = b.precio || 0;
              break;
            case 'stock':
              // Manejar diferentes estructuras de datos del stock
              valorA = 0;
              valorB = 0;
              
              if (a.stock) {
                if (typeof a.stock === 'object' && a.stock.cantidad !== undefined) {
                  valorA = a.stock.cantidad;
                } else if (typeof a.stock === 'number') {
                  valorA = a.stock;
                }
              }
              
              if (b.stock) {
                if (typeof b.stock === 'object' && b.stock.cantidad !== undefined) {
                  valorB = b.stock.cantidad;
                } else if (typeof b.stock === 'number') {
                  valorB = b.stock;
                }
              }
              
              valorA = Number(valorA) || 0;
              valorB = Number(valorB) || 0;
              break;
            default:
              return 0;
          }

          if (valorA < valorB) return ordenActual.direccion === 'asc' ? -1 : 1;
          if (valorA > valorB) return ordenActual.direccion === 'asc' ? 1 : -1;
          return 0;
        });

        renderizarTabla(productosOrdenados);
      }

      // --- Funci√≥n de filtrado ---
      function filterTable() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (!searchTerm) {
          // Si no hay t√©rmino de b√∫squeda, mostrar todos los productos
          if (ordenActual.campo) {
            ordenarTabla(ordenActual.campo);
          } else {
            renderizarTabla(productosOriginales);
          }
          return;
        }

        const productosFiltrados = productosOriginales.filter(producto => {
          return (
            producto.nombre?.toLowerCase().includes(searchTerm) ||
            producto.codigo?.toLowerCase().includes(searchTerm) ||
            producto.id?.toString().includes(searchTerm)
          );
        });

        renderizarTabla(productosFiltrados);
      }

      // --- Funciones de modal para productos ---
      function abrirModal(esEdicion = false, producto = null) {
        editandoProductoId = esEdicion ? producto.id : null;
        
        // Actualizar t√≠tulo y icono
        if (esEdicion) {
          modalTitle.textContent = "Editar Producto";
          document.getElementById("modalIcon").setAttribute("data-lucide", "edit");
        } else {
          modalTitle.textContent = "Nuevo Producto";
          document.getElementById("modalIcon").setAttribute("data-lucide", "package-plus");
        }

        // Limpiar o rellenar formulario
        document.getElementById("codigoProd").value = producto?.codigo || "";
        document.getElementById("nombreProd").value = producto?.nombre || "";
        document.getElementById("precioProd").value = producto?.precio || "";
        document.getElementById("stockProd").value = producto?.stock?.cantidad || "";

        modalProducto.classList.remove("hidden");
        
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }

      function cerrarModal() {
        modalProducto.classList.add("hidden");
        editandoProductoId = null;
        document.getElementById("formProducto").reset();
      }

      // --- Funciones para eliminar productos ---
      function confirmarEliminarProducto(id, nombre, codigo) {
        eliminarProductoId = id;
        nombreProductoEliminar.textContent = nombre;
        codigoProductoEliminar.textContent = codigo ? `C√≥digo: ${codigo}` : "Sin c√≥digo";
        modalConfirmarEliminar.classList.remove("hidden");
      }

      // --- Funci√≥n para editar producto ---
      async function editarProducto(id) {
        try {
          const res = await fetch(`${BACKEND_URL}/ventas/productos/${id}/`, {
            method: "GET",
            headers,
          });
          
          if (!res.ok) throw new Error("Error al obtener producto");
          
          const producto = await res.json();
          
          // Obtener stock del producto
          const stockRes = await fetch(`${BACKEND_URL}/ventas/stocks/?producto=${id}`, {
            method: "GET",
            headers,
          });
          
          if (stockRes.ok) {
            const stocks = await stockRes.json();
            if (stocks.length > 0) {
              producto.stock = stocks[0];
            }
          }
          
          abrirModal(true, producto);
        } catch (err) {
          console.error(err);
          await showErrorModal("Error al cargar producto", "No se pudo cargar la informaci√≥n del producto para editar.");
        }
      }

      // Al enviar el formulario del modal (crear o editar)
      formProducto.addEventListener("submit", async (e) => {
        e.preventDefault();
        const codigo = document.getElementById("codigoProd").value.trim();
        const nombre = document.getElementById("nombreProd").value.trim();
        const precio = parseFloat(document.getElementById("precioProd").value) || 0;
        const stockCantidad = parseInt(document.getElementById("stockProd").value, 10) || 0;

        if (!nombre) {
          await showErrorModal("Campo requerido", "El nombre del producto es obligatorio.");
          return;
        }

        try {
          let prodId = editandoProductoId;
          let productoPayload = { codigo, nombre, precio };
          let productoRes;

          if (!prodId) {
            // Crear nuevo producto
            const r = await fetch(`${BACKEND_URL}/ventas/productos/`, {
              method: "POST",
              headers,
              body: JSON.stringify(productoPayload),
            });
            if (!r.ok) {
              const eJson = await r.json();
              console.error("Error al crear producto:", eJson);
              let errorMsg = "Error al crear el producto.";
              if (eJson.codigo && eJson.codigo[0]) {
                errorMsg = `Error: ${eJson.codigo[0]}`;
              }
              await showErrorModal("Error al crear producto", errorMsg);
              return;
            }
            productoRes = await r.json();
            prodId = productoRes.id;
            showToast("Producto creado correctamente.", 'success');
          } else {
            // Editar producto existente
            const r = await fetch(`${BACKEND_URL}/ventas/productos/${prodId}/`, {
              method: "PUT",
              headers,
              body: JSON.stringify(productoPayload),
            });
            if (!r.ok) {
              const eJson = await r.json();
              console.error("Error al actualizar producto:", eJson);
              let errorMsg = "Error al actualizar el producto.";
              if (eJson.codigo && eJson.codigo[0]) {
                errorMsg = `Error: ${eJson.codigo[0]}`;
              }
              await showErrorModal("Error al actualizar producto", errorMsg);
              return;
            }
            productoRes = await r.json();
            showToast("Producto actualizado correctamente.", 'success');
          }

          // Ahora manejamos el Stock asociado
          const stocksR = await fetch(`${BACKEND_URL}/ventas/stocks/?producto=${prodId}`, {
            method: "GET",
            headers,
          });
          
          if (stocksR.ok) {
            const stocksData = await stocksR.json();

            if (stocksData.length > 0) {
              // Actualizar stock existente
              const stockId = stocksData[0].id;
              await fetch(`${BACKEND_URL}/ventas/stocks/${stockId}/`, {
                method: "PUT",
                headers,
                body: JSON.stringify({ producto: prodId, cantidad: stockCantidad }),
              });
            } else {
              // Crear stock nuevo
              await fetch(`${BACKEND_URL}/ventas/stocks/`, {
                method: "POST",
                headers,
                body: JSON.stringify({ producto: prodId, cantidad: stockCantidad }),
              });
            }
          }

          // Cerrar modal y recargar lista
          cerrarModal();
          cargarInventario();
        } catch (err) {
          console.error(err);
          await showErrorModal("Error al guardar producto", "No se pudo guardar el producto. Verifique los datos e intente nuevamente.");
        }
      });

      // Al cargar la p√°gina, verificar acceso y obtener el inventario
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAccess();
        cargarInventario();
        searchInput.addEventListener("input", filterTable);
        
        // Event listeners para modales
        btnNuevoProducto.addEventListener("click", () => abrirModal(false));
        btnCerrarModal.addEventListener("click", cerrarModal);
        btnCancelarModal.addEventListener("click", cerrarModal);
        
        // Event listeners para CSV
        btnImportar.addEventListener("click", () => inputImportarCSV.click());
        btnActualizar.addEventListener("click", () => inputActualizarCSV.click());
        
        inputImportarCSV.addEventListener("change", (e) => {
          if (e.target.files[0]) {
            procesarCSVOptimizado(e.target.files[0], false);
            e.target.value = ""; // Reset input
          }
        });
        
        inputActualizarCSV.addEventListener("change", (e) => {
          if (e.target.files[0]) {
            procesarCSVOptimizado(e.target.files[0], true);
            e.target.value = ""; // Reset input
          }
        });
        
        // Inicializar Lucide icons
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
        
        // Listener para confirmar eliminaci√≥n de producto
        btnConfirmarEliminar.addEventListener("click", async () => {
          if (!eliminarProductoId) return;
          try {
            const r = await fetch(`${BACKEND_URL}/ventas/productos/${eliminarProductoId}/`, {
              method: "DELETE",
              headers,
            });
            if (!r.ok) throw new Error(`Error HTTP ${r.status}`);
            showToast("Producto eliminado correctamente.", 'success');
            cerrarConfirmEliminar();
            cargarInventario();
          } catch (err) {
            console.error(err);
            showToast("Error al eliminar producto.", 'error');
          }
        });
      
        // Listeners para cerrar modal de eliminaci√≥n
        btnCerrarModalEliminar.addEventListener("click", cerrarConfirmEliminar);
        btnCancelarEliminar.addEventListener("click", cerrarConfirmEliminar);
        
        // Cerrar modales con Escape
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (!modalProducto.classList.contains("hidden")) {
              cerrarModal();
            }
            if (!modalConfirmarEliminar.classList.contains("hidden")) {
              cerrarConfirmEliminar();
            }
          }
        });
        
        // Cerrar modales al hacer clic fuera
        modalProducto.addEventListener("click", (e) => {
          if (e.target === modalProducto) {
            cerrarModal();
          }
        });
        
        modalConfirmarEliminar.addEventListener("click", (e) => {
          if (e.target === modalConfirmarEliminar) {
            cerrarConfirmEliminar();
          }
        });
      });

      async function checkAccess() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/";
          return;
        }

        try {
          const resp = await fetch(`${BACKEND_URL}/ventas/user/me/`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          
          if (!resp.ok) {
            localStorage.removeItem("token");
            window.location.href = "/";
            return;
          }
          
          const user = await resp.json();
          
          // Mostrar informaci√≥n del usuario
          const fullName = `${user.first_name} ${user.last_name}`.trim();
          const displayName = fullName || user.username;
          const roleName = user.role === 'ADMIN' ? 'Administrador' : 'Empleado';
          document.getElementById("userInfo").textContent = `${displayName} (${roleName})`;
          
          // Mostrar tambi√©n en mobile
          const userInfoMobile = document.getElementById("userInfoMobile");
          if (userInfoMobile) {
            userInfoMobile.textContent = `${displayName} (${roleName})`;
          }
          
          // Si es empleado, mostrar mensaje de acceso denegado
          if (user.role === 'EMPLOYEE') {
            document.getElementById("accessDenied").classList.remove("hidden");
            // Inicializar √≠conos en el mensaje de acceso denegado
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            return;
          }
          
        } catch (err) {
          console.error("Error al verificar acceso:", err);
          window.location.href = "/";
        }
      }

      // Hacer funciones globales para que est√©n disponibles desde onclick
      window.editarProducto = editarProducto;
      window.confirmarEliminarProducto = confirmarEliminarProducto;
      window.ordenarTabla = ordenarTabla;
    </script>
  </body>
</html>