<!-- frontend-node/public/inventario.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario ‚Äì ManuMarket</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      /* Animaciones personalizadas */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      /* Gradiente personalizado */
      .bg-gradient-custom {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e40af 100%);
      }
      
      /* Efectos de vidrio */
      .glass-effect {
        backdrop-filter: blur(16px);
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
      
      .glass-card {
        backdrop-filter: blur(8px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
      }
      
      .animate-slide-in {
        animation: slideIn 0.5s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-custom">
    <!-- Verificaci√≥n de acceso -->
    <div id="accessDenied" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <div class="text-center">
          <i data-lucide="shield-x" class="mx-auto h-12 w-12 text-red-500 mb-4"></i>
          <h3 class="mt-4 text-lg font-medium text-gray-900">Acceso Denegado</h3>
          <p class="mt-2 text-sm text-gray-500">
            No tienes permisos para acceder al inventario. Solo los administradores pueden gestionar el inventario.
          </p>
          <div class="mt-6">
            <a href="/dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg inline-flex items-center gap-2">
              <i data-lucide="arrow-left" class="w-4 h-4"></i>
              Volver al Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

        <!-- Barra de navegaci√≥n moderna -->
    <nav class="glass-effect border-b border-white/10 animate-slide-in">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <!-- Logo y brand -->
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 bg-blue-600 p-3 rounded-xl shadow-lg">
              <i data-lucide="shopping-cart" class="w-7 h-7 text-white"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-white">ManuMarket</h1>
              <p class="text-sm text-slate-300">Gesti√≥n de Inventario</p>
            </div>
          </div>

          <!-- Navigation Links Desktop -->
          <div id="navigationLinks" class="hidden md:flex md:space-x-2">
            <a href="/dashboard" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a id="inventarioLink" href="/inventario" class="inline-flex items-center px-5 py-3 rounded-xl bg-blue-600/30 text-white font-semibold text-base border border-blue-500/50 space-x-2 shadow-lg">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>Inventario</span>
            </a>
            <a href="/pos" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="shopping-bag" class="w-5 h-5"></i>
              <span>POS</span>
            </a>
            <a href="/historial-ventas" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="history" class="w-5 h-5"></i>
              <span>Historial</span>
            </a>
            <a id="trabajadoresLink" href="/trabajadores" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Trabajadores</span>
            </a>
          </div>

          <!-- User info y logout -->
          <div class="flex items-center space-x-5">
            <div class="text-right hidden sm:block">
              <p id="userInfo" class="text-base font-bold text-white">‚Äî</p>
              <p class="text-sm text-slate-200">Bienvenido</p>
            </div>
            <a href="/logout" class="inline-flex items-center px-5 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base transition-all duration-200 space-x-2 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Salir</span>
            </a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button id="btnMenuInv" class="inline-flex items-center justify-center p-3 rounded-xl text-white hover:text-white hover:bg-white/20 transition-all duration-200">
              <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="menuResponsiveInv" class="md:hidden hidden border-t border-white/10 bg-slate-900/50">
        <div class="px-4 pt-2 pb-3 space-y-1">
          <a href="/dashboard" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
          <a id="inventarioLinkMobile" href="/inventario" class="flex items-center px-4 py-3 rounded-xl bg-blue-600/30 text-white font-bold text-base space-x-3 border border-blue-500/50 shadow-lg">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span>Inventario</span>
          </a>
          <a href="/pos" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span>POS</span>
          </a>
          <a href="/historial-ventas" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="history" class="w-5 h-5"></i>
            <span>Historial de Ventas</span>
          </a>
          <a id="trabajadoresLinkMobile" href="/trabajadores" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span>Trabajadores</span>
          </a>
          <div class="border-t border-white/10 pt-3 mt-3">
            <div class="px-4 py-2">
              <p id="userInfoMobile" class="text-base font-bold text-white">‚Äî</p>
            </div>
            <a href="/logout" class="flex items-center px-4 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base space-x-3 transition-all duration-200 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span>Cerrar sesi√≥n</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <script>
      const btnMenuInv = document.getElementById("btnMenuInv");
      const menuResponsiveInv = document.getElementById("menuResponsiveInv");
      btnMenuInv && btnMenuInv.addEventListener("click", () => {
        menuResponsiveInv.classList.toggle("hidden");
      });
      
      // Inicializar iconos
      lucide.createIcons();
    </script>

    <!-- CONTENIDO: LISTADO DE PRODUCTOS -->
    <main class="max-w-7xl mx-auto p-6 animate-fade-in">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
        <div class="flex items-center gap-3">
          <i data-lucide="package" class="w-8 h-8 text-white"></i>
          <h1 class="text-2xl font-semibold text-white">Inventario</h1>
        </div>
      </div>

        <div class="flex justify-end space-x-2 w-full sm:w-auto mb-4">
          <div class="relative w-64">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-white/70"></i>
            <input
              id="searchInput"
              type="text"
              placeholder="Buscar producto..."
              class="pl-10 flex-1 border border-white/20 bg-white/10 text-white placeholder-white/70 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full backdrop-blur-sm"
            />
          </div>
          <!-- Bot√≥n Importar (azul) -->
          <button
            id="btnImportar"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center gap-2"
            title="Importar productos nuevos desde CSV (no actualiza existentes)"
          >
            <i data-lucide="upload" class="w-4 h-4"></i>
            Importar
          </button>
          <!-- Bot√≥n Actualizar (naranja) -->
          <button
            id="btnActualizar"
            class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 flex items-center gap-2"
            title="Actualizar inventario desde CSV (crea nuevos y actualiza existentes)"
          >
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Actualizar
          </button>
          <!-- Bot√≥n Exportar (morado) -->
          <button
            id="btnExportar"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 flex items-center gap-2"
          >
            <i data-lucide="download" class="w-4 h-4"></i>
            Exportar
          </button>
          <!-- Bot√≥n Nuevo Producto (verde) -->
          <button
            id="btnNuevoProducto"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center gap-2"
          >
            <i data-lucide="plus" class="w-4 h-4"></i>
            Nuevo Producto
          </button>
        </div>
      </div>

      <div class="glass-card rounded-2xl overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center gap-1">
                  <i data-lucide="hash" class="w-3 h-3"></i>
                  ID
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center gap-1">
                  <i data-lucide="qr-code" class="w-3 h-3"></i>
                  C√≥digo de Barra
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" 
                  onclick="ordenarTabla('nombre')" title="Clic para ordenar por nombre">
                <div class="flex items-center gap-1">
                  <i data-lucide="tag" class="w-3 h-3"></i>
                  Nombre <span id="sort-nombre" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" 
                  onclick="ordenarTabla('precio')" title="Clic para ordenar por precio">
                <div class="flex items-center gap-1">
                  <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                  Precio <span id="sort-precio" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" 
                  onclick="ordenarTabla('stock')" title="Clic para ordenar por stock">
                <div class="flex items-center gap-1">
                  <i data-lucide="package-2" class="w-3 h-3"></i>
                  Stock <span id="sort-stock" class="ml-1 text-gray-400">‚Üï</span>
                </div>
              </th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="flex items-center justify-center gap-1">
                  <i data-lucide="settings" class="w-3 h-3"></i>
                  Acciones
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="tbodyInventario" class="bg-white divide-y divide-gray-200">
            <!-- JS inyectar√° aqu√≠ las filas -->
          </tbody>
        </table>
      </div>
    </main>

    <!-- Inputs ocultos para importar CSV -->
    <input type="file" id="inputImportarCSV" accept=".csv" class="hidden" />
    <input type="file" id="inputActualizarCSV" accept=".csv" class="hidden" />

    <!-- Modal HTML para crear/editar producto (hidden por defecto) -->
    <div id="modalProducto" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalTitle" class="text-xl font-semibold text-gray-800 flex items-center gap-2">
            <i data-lucide="package-plus" class="w-5 h-5"></i>
            Nuevo Producto
          </h2>
          <button id="btnCerrarModal" class="text-gray-400 hover:text-gray-600">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <form id="formProducto" class="space-y-4">
          <div>
            <label for="codigoProd" class="block text-sm font-medium text-gray-700 flex items-center gap-1">
              <i data-lucide="qr-code" class="w-3 h-3"></i>
              C√≥digo de Barra
            </label>
            <input
              id="codigoProd"
              type="text"
              class="mt-1 w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label for="nombreProd" class="block text-sm font-medium text-gray-700 flex items-center gap-1">
              <i data-lucide="tag" class="w-3 h-3"></i>
              Nombre <span class="text-red-500">*</span>
            </label>
            <input
              id="nombreProd"
              type="text"
              required
              class="mt-1 w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label for="precioProd" class="block text-sm font-medium text-gray-700 flex items-center gap-1">
              <i data-lucide="dollar-sign" class="w-3 h-3"></i>
              Precio
            </label>
            <input
              id="precioProd"
              type="number"
              step="10"
              min="0"
              class="mt-1 w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label for="stockProd" class="block text-sm font-medium text-gray-700 flex items-center gap-1">
              <i data-lucide="package-2" class="w-3 h-3"></i>
              Cantidad en Stock
            </label>
            <input
              id="stockProd"
              type="number"
              min="0"
              class="mt-1 w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="flex justify-end space-x-2 pt-4">
            <button type="button" id="btnCancelarModal" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 flex items-center gap-1">
              <i data-lucide="x" class="w-4 h-4"></i>
              Cancelar
            </button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-1">
              <i data-lucide="save" class="w-4 h-4"></i>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // BASE URL de tu API Django (ventas_api)
      const BACKEND_URL = "http://localhost:8000";
      const token = localStorage.getItem("token");
      // Agrega el header Authorization si hay token
      const headers = token
        ? { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }
        : { "Content-Type": "application/json" };

      const tbodyInventario = document.getElementById("tbodyInventario");
      const btnNuevoProducto = document.getElementById("btnNuevoProducto");
      const modalProducto = document.getElementById("modalProducto");
      const formProducto = document.getElementById("formProducto");
      const modalTitle = document.getElementById("modalTitle");
      const btnCerrarModal = document.getElementById("btnCerrarModal");
      const btnCancelarModal = document.getElementById("btnCancelarModal");
      const btnImportar = document.getElementById("btnImportar");
      const btnActualizar = document.getElementById("btnActualizar");
      const btnExportar = document.getElementById("btnExportar");
      const inputImportarCSV = document.getElementById("inputImportarCSV");
      const inputActualizarCSV = document.getElementById("inputActualizarCSV");
      const searchInput = document.getElementById("searchInput");

      let editandoProductoId = null;
      
      // Variables para el ordenamiento
      let ordenActual = {
        campo: null,        // 'nombre', 'precio', 'stock'
        direccion: 'asc'    // 'asc' o 'desc'
      };
      let productosOriginales = []; // Array para mantener los datos originales

      // Funci√≥n para ordenar la tabla
      function ordenarTabla(campo) {
        // Si hacemos clic en el mismo campo, cambiar direcci√≥n
        if (ordenActual.campo === campo) {
          ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
          // Nuevo campo, empezar con ascendente
          ordenActual.campo = campo;
          ordenActual.direccion = 'asc';
        }

        // Actualizar indicadores visuales
        actualizarIndicadoresOrden();

        // Ordenar los datos
        const productosOrdenados = [...productosOriginales].sort((a, b) => {
          let valorA, valorB;

          switch (campo) {
            case 'nombre':
              valorA = a.nombre.toLowerCase();
              valorB = b.nombre.toLowerCase();
              break;
            case 'precio':
              valorA = parseFloat(a.precio) || 0;
              valorB = parseFloat(b.precio) || 0;
              break;
            case 'stock':
              valorA = parseInt(a.stock) || 0;
              valorB = parseInt(b.stock) || 0;
              break;
            default:
              return 0;
          }

          let resultado = 0;
          if (valorA < valorB) resultado = -1;
          else if (valorA > valorB) resultado = 1;

          return ordenActual.direccion === 'desc' ? -resultado : resultado;
        });

        // Renderizar la tabla ordenada
        renderizarTabla(productosOrdenados);
      }

      // Funci√≥n para actualizar los indicadores visuales de ordenamiento
      function actualizarIndicadoresOrden() {
        // Resetear todos los indicadores
        ['nombre', 'precio', 'stock'].forEach(campo => {
          const indicador = document.getElementById(`sort-${campo}`);
          if (indicador) {
            indicador.textContent = '‚Üï';
            indicador.className = 'ml-1 text-gray-400';
          }
        });

        // Actualizar el indicador activo
        if (ordenActual.campo) {
          const indicadorActivo = document.getElementById(`sort-${ordenActual.campo}`);
          if (indicadorActivo) {
            indicadorActivo.textContent = ordenActual.direccion === 'asc' ? '‚Üë' : '‚Üì';
            indicadorActivo.className = 'ml-1 text-blue-600 font-bold';
          }
        }
      }

      // Funci√≥n para renderizar la tabla con los productos dados
      function renderizarTabla(productos) {
        tbodyInventario.innerHTML = "";

        productos.forEach((prod) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";

          // Determinar el badge y color del stock
          const stockValue = parseInt(prod.stock) || 0;
          let stockDisplay = '';
          let stockClass = '';
          
          if (stockValue === 0) {
            stockDisplay = 'Sin stock';
            stockClass = 'text-red-600 bg-red-50 border border-red-200';
          } else if (stockValue < 10) {
            stockDisplay = `Bajo: ${stockValue}`;
            stockClass = 'text-yellow-600 bg-yellow-50 border border-yellow-200';
          } else {
            stockDisplay = stockValue.toString();
            stockClass = 'text-green-600 bg-green-50 border border-green-200';
          }

          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${prod.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${prod.codigo}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${prod.nombre}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
              ${new Intl.NumberFormat("es-CL", { style: "currency", currency: "CLP" }).format(parseFloat(prod.precio))}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${stockClass}">
                ${stockDisplay}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center">
              <div class="flex justify-center gap-2">
                <button data-id="${prod.id}" class="btnEditar inline-flex items-center gap-1 px-3 py-1 bg-yellow-400 text-white rounded hover:bg-yellow-500 text-xs">
                  <i data-lucide="edit-2" class="w-3 h-3"></i>
                  Editar
                </button>
                <button data-id="${prod.id}" class="btnEliminar inline-flex items-center gap-1 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                  Eliminar
                </button>
              </div>
            </td>
          `;
          tbodyInventario.appendChild(tr);
        });

        // Inicializar Lucide icons para los nuevos elementos
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }

        // Aplicar filtro despu√©s de renderizar
        filterTable();
        // Reagregar listeners a los botones
        agregarListenersProductos();
      }

      // Funci√≥n para agregar listeners a los botones de Editar y Eliminar
      function agregarListenersProductos() {
        // Agregar listeners a los botones Editar
        document.querySelectorAll(".btnEditar").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            try {
              // 1) Obtener datos del producto
              const r = await fetch(`${BACKEND_URL}/ventas/productos/${id}/`, {
                method: "GET",
                headers,
              });

              if (!r.ok) {
                throw new Error(`Error HTTP ${r.status}: ${r.statusText}`);
              }

              const producto = await r.json();

              // 2) Obtener stock asociado (si existe)
              const stocksR = await fetch(`${BACKEND_URL}/ventas/stocks/?producto=${id}`, { 
                method: "GET",
                headers 
              });

              if (!stocksR.ok) {
                throw new Error(`Error HTTP ${stocksR.status}: ${stocksR.statusText}`);
              }

              const stocksData = await stocksR.json();
              const cantidadStock = stocksData.length > 0 ? stocksData[0].cantidad : 0;

              // 3) Abrir modal con datos precargados
              abrirModal(false, {
                id: producto.id,
                codigo: producto.codigo,
                nombre: producto.nombre,
                precio: producto.precio,
                stock: cantidadStock
              });
            } catch (err) {
              console.error("Error detallado:", err);
              alert(`Error al cargar datos del producto: ${err.message}`);
            }
          });
        });

        // Agregar listeners a los botones Eliminar
        document.querySelectorAll(".btnEliminar").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm("¬øEliminar este producto del inventario? (Se mantendr√° en el historial de ventas)")) return;
            try {
              // Usar soft delete - el producto se marca como eliminado pero no se borra f√≠sicamente
              const response = await fetch(`${BACKEND_URL}/ventas/productos/${id}/`, {
                method: "DELETE",
                headers,
              });
              
              if (response.status === 204) {
                // Eliminaci√≥n exitosa
                alert("Producto eliminado del inventario correctamente");
                cargarInventario();
              } else {
                // Otros errores
                throw new Error(`Error HTTP: ${response.status}`);
              }
            } catch (err) {
              console.error(err);
              alert("Error al eliminar producto: " + err.message);
            }
          });
        });
      }

      // Funci√≥n para abrir modal (crear o editar)
      function abrirModal(nuevo = true, producto = {}) {
        modalProducto.classList.remove("hidden");
        if (nuevo) {
          modalTitle.innerHTML = `<i data-lucide="package-plus" class="w-5 h-5"></i> Nuevo Producto`;
          document.getElementById("codigoProd").value = "";
          document.getElementById("nombreProd").value = "";
          document.getElementById("precioProd").value = "";
          document.getElementById("stockProd").value = "";
          editandoProductoId = null;
        } else {
          modalTitle.innerHTML = `<i data-lucide="edit" class="w-5 h-5"></i> Editar Producto`;
          document.getElementById("codigoProd").value = producto.codigo;
          document.getElementById("nombreProd").value = producto.nombre;
          document.getElementById("precioProd").value = producto.precio;
          document.getElementById("stockProd").value = producto.stock;
          editandoProductoId = producto.id;
        }
        
        // Inicializar √≠conos de Lucide en el modal
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }

      function cerrarModal() {
        modalProducto.classList.add("hidden");
      }

      // Listener para "+ Nuevo Producto"
      btnNuevoProducto.addEventListener("click", () => abrirModal());
      btnCerrarModal.addEventListener("click", cerrarModal);
      btnCancelarModal.addEventListener("click", cerrarModal);

      // Funci√≥n para filtrar filas en la tabla seg√∫n el texto de b√∫squeda
      function filterTable() {
        const term = searchInput.value.toLowerCase();
        document.querySelectorAll("#tbodyInventario tr").forEach((row) => {
          const codigo = row.children[1].textContent.toLowerCase();
          const nombre = row.children[2].textContent.toLowerCase();
          if (codigo.includes(term) || nombre.includes(term)) {
            row.style.display = "";   // mu√©stralo
          } else {
            row.style.display = "none"; // lo oculta
          }
        });
      }

      // --- Importar y Actualizar Inventario desde CSV (OPTIMIZADO) ---
      
      // Funci√≥n para comprimir datos con base64 y gzip (si est√° disponible)
      async function comprimirDatos(jsonString) {
        try {
          // Usar solo base64 para mayor compatibilidad
          // El uso de unescape/encodeURIComponent maneja caracteres especiales
          return btoa(unescape(encodeURIComponent(jsonString)));
        } catch (error) {
          console.warn('Error en compresi√≥n base64:', error);
          return jsonString; // Fallback a texto plano
        }
      }
      
      // Funci√≥n optimizada para archivos grandes
      async function procesarCSVOptimizado(file, esActualizacion = false) {
        if (!file) return;

        try {
          // Validar tama√±o del archivo
          const maxSize = 50 * 1024 * 1024; // 50MB
          if (file.size > maxSize) {
            alert("Archivo muy grande. M√°ximo permitido: 50MB");
            return;
          }

          const text = await file.text();
          const lines = text.trim().split("\n");
          
          if (lines.length <= 1) {
            alert("El archivo CSV est√° vac√≠o o solo contiene cabeceras.");
            return;
          }

          lines.shift(); // quitar cabecera
          
          // Procesar en chunks para archivos grandes
          const chunkSize = 500; // 500 productos por chunk
          const totalProductos = lines.length;
          const totalChunks = Math.ceil(totalProductos / chunkSize);
          
          if (totalProductos > chunkSize) {
            if (!confirm(`El archivo contiene ${totalProductos} productos. Se procesar√° en ${totalChunks} lotes de ${chunkSize} productos. ¬øContinuar?`)) {
              return;
            }
          }

          // Bot√≥n loading
          const btn = esActualizacion ? btnActualizar : btnImportar;
          const textoOriginal = btn.innerHTML;
          
          let productosCreados = 0;
          let productosActualizados = 0;
          let errores = 0;

          // Procesar chunks secuencialmente
          for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, totalProductos);
            const chunk = lines.slice(start, end);
            
            // Actualizar progreso
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Procesando ${i + 1}/${totalChunks} (${Math.round(((i + 1) / totalChunks) * 100)}%)`;
            btn.disabled = true;
            
            // Reinicializar √≠conos
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            
            const productos = [];
            
            // Procesar chunk actual
            for (const line of chunk) {
              const values = line.split(",").map(v => v.replace(/^"|"$/g, "").trim());
              const codigo = values[1];
              const nombre = values[2];
              let precioRaw = values[3] || "";

              if (precioRaw.toLowerCase() === "null" || precioRaw === "") {
                precioRaw = "0";
              }
              let precio = parseInt(precioRaw, 10);
              if (isNaN(precio)) precio = 0;

              if (!codigo) continue;

              productos.push({
                codigo: codigo,
                nombre: nombre || "",
                precio: precio
              });
            }

            if (productos.length === 0) continue;

            // VERSI√ìN COMPRIMIDA: Convertir a base64 comprimido
            const jsonString = JSON.stringify(productos);
            const compressed = await comprimirDatos(jsonString);
            
            // Enviar chunk al backend
            const endpoint = esActualizacion ? 'bulk-update' : 'bulk-import';
            
            try {
              const response = await fetch(`${BACKEND_URL}/ventas/productos/${endpoint}/`, {
                method: "POST",
                headers: {
                  ...headers
                },
                body: JSON.stringify({ 
                  productos_compressed: compressed,
                  chunk_info: {
                    current: i + 1,
                    total: totalChunks,
                    productos_en_chunk: productos.length
                  }
                })
              });

              if (!response.ok) {
                console.error(`Error HTTP ${response.status}:`, response.statusText);
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
              }

              const result = await response.json();

              if (response.ok) {
                productosCreados += result.productos_creados || 0;
                productosActualizados += result.productos_actualizados || 0;
                errores += result.errores || 0;
              } else {
                console.error(`Error en chunk ${i + 1}:`, result);
                errores += productos.length;
              }

            } catch (fetchError) {
              console.error(`Error de red en chunk ${i + 1}:`, fetchError);
              
              // Si es un error de red, intentar una vez m√°s con datos sin comprimir
              if (fetchError.message.includes('NetworkError') || fetchError.message.includes('fetch')) {
                console.log(`Reintentando chunk ${i + 1} sin compresi√≥n...`);
                try {
                  const response = await fetch(`${BACKEND_URL}/ventas/productos/${endpoint}/`, {
                    method: "POST",
                    headers: {
                      ...headers
                    },
                    body: JSON.stringify({ 
                      productos: productos,
                      chunk_info: {
                        current: i + 1,
                        total: totalChunks,
                        productos_en_chunk: productos.length
                      }
                    })
                  });

                  if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                  }

                  const result = await response.json();
                  productosCreados += result.productos_creados || 0;
                  productosActualizados += result.productos_actualizados || 0;
                  errores += result.errores || 0;
                  
                  console.log(`‚úÖ Chunk ${i + 1} procesado sin compresi√≥n`);
                } catch (retryError) {
                  console.error(`Error en reintento de chunk ${i + 1}:`, retryError);
                  errores += productos.length;
                }
              } else {
                errores += productos.length;
              }
            }

            // Peque√±a pausa para no saturar el servidor
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          // Mostrar resultado final
          let mensaje = `‚úÖ Procesamiento completado!\n\n`;
          mensaje += `üìä Resumen:\n`;
          mensaje += `‚Ä¢ Total productos: ${totalProductos}\n`;
          mensaje += `‚Ä¢ Productos creados: ${productosCreados}\n`;
          if (esActualizacion) {
            mensaje += `‚Ä¢ Productos actualizados: ${productosActualizados}\n`;
          }
          mensaje += `‚Ä¢ Errores: ${errores}\n`;
          mensaje += `‚Ä¢ Procesado en ${totalChunks} lotes`;

          alert(mensaje);
          cargarInventario();

        } catch (error) {
          console.error("Error completo al procesar CSV:", {
            error: error,
            message: error.message,
            stack: error.stack,
            backendUrl: BACKEND_URL,
            token: token ? "presente" : "ausente"
          });
          
          // Mostrar error m√°s espec√≠fico al usuario
          let errorMsg = "Error al procesar el archivo CSV: ";
          if (error.message.includes('NetworkError')) {
            errorMsg += "No se puede conectar al servidor. Verifique que:\n";
            errorMsg += "‚Ä¢ El servidor backend est√© ejecut√°ndose\n";
            errorMsg += "‚Ä¢ La URL del backend sea correcta\n";
            errorMsg += "‚Ä¢ No haya problemas de red";
          } else if (error.message.includes('401')) {
            errorMsg += "Token de autenticaci√≥n expirado. Inicie sesi√≥n nuevamente.";
          } else if (error.message.includes('403')) {
            errorMsg += "No tiene permisos para realizar esta operaci√≥n.";
          } else {
            errorMsg += error.message;
          }
          
          alert(errorMsg);
        } finally {
          // Restaurar bot√≥n
          const btn = esActualizacion ? btnActualizar : btnImportar;
          const textoOriginal = esActualizacion ? 
            `<i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualizar` : 
            `<i data-lucide="upload" class="w-4 h-4"></i> Importar`;
          btn.innerHTML = textoOriginal;
          btn.disabled = false;
          
          // Reinicializar √≠conos
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }
      }

      // Event listeners optimizados
      btnImportar.addEventListener("click", () => {
        inputImportarCSV.click();
      });

      btnActualizar.addEventListener("click", () => {
        inputActualizarCSV.click();
      });

      inputImportarCSV.addEventListener("change", async function (e) {
        await procesarCSVOptimizado(e.target.files[0], false);
        this.value = "";
      });

      inputActualizarCSV.addEventListener("change", async function (e) {
        await procesarCSVOptimizado(e.target.files[0], true);
        this.value = "";
      });

      // --- Exportar Inventario a CSV ---
      function exportarCSV() {
        const filas = [];
        // Cabecera con 4 columnas
        filas.push(["ID", "C√≥digo de Barra", "Nombre", "Precio"]);

        document.querySelectorAll("#tbodyInventario tr").forEach((tr) => {
          const cols = tr.querySelectorAll("td");
          const id = cols[0].textContent.trim();
          const codigo = cols[1].textContent.trim();
          const nombre = cols[2].textContent.trim();
          // Limpiar s√≠mbolos de moneda y puntos del precio (col[3])
          const precio = cols[3]
            .textContent
            .trim()
            .replace(/\$/g, "")
            .replace(/\./g, "")
            .replace(/\s/g, "");
          filas.push([id, codigo, nombre, precio]);
        });

        const csvContent = filas
          .map((r) => r.map((v) => `"${v.replace(/"/g, '""')}"`).join(","))
          .join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "inventario_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      btnExportar.addEventListener("click", exportarCSV);

      // --- Cargar lista de productos ---
      async function cargarInventario() {
        try {
          const res = await fetch(`${BACKEND_URL}/ventas/productos/`, {
            method: "GET",
            headers,
          });
          if (!res.ok) throw new Error("Error al cargar inventario");
          const productos = await res.json();
          
          // Guardar los productos originales
          productosOriginales = productos;
          
          // Si hay un ordenamiento activo, aplicarlo
          if (ordenActual.campo) {
            ordenarTabla(ordenActual.campo);
          } else {
            // Si no hay ordenamiento, renderizar normalmente
            renderizarTabla(productos);
          }

        } catch (err) {
          console.error(err);
          alert("Error al cargar inventario.");
        }
      }

      // Al enviar el formulario del modal (crear o editar)
      formProducto.addEventListener("submit", async (e) => {
        e.preventDefault();
        const codigo = document.getElementById("codigoProd").value.trim();
        const nombre = document.getElementById("nombreProd").value.trim();
        const precio = parseFloat(document.getElementById("precioProd").value);
        const stockCantidad = parseInt(document.getElementById("stockProd").value, 10);

        try {
          let prodId = editandoProductoId;
          let productoPayload = { codigo, nombre, precio };
          let productoRes;

          if (!prodId) {
            // Crear nuevo producto
            const r = await fetch(`${BACKEND_URL}/ventas/productos/`, {
              method: "POST",
              headers,
              body: JSON.stringify(productoPayload),
            });
            if (!r.ok) {
              const eJson = await r.json();
              alert("Error al crear producto: " + JSON.stringify(eJson));
              return;
            }
            productoRes = await r.json();
            prodId = productoRes.id;
          } else {
            // Editar producto existente
            const r = await fetch(`${BACKEND_URL}/ventas/productos/${prodId}/`, {
              method: "PUT",
              headers,
              body: JSON.stringify(productoPayload),
            });
            if (!r.ok) {
              const eJson = await r.json();
              alert("Error al actualizar producto: " + JSON.stringify(eJson));
              return;
            }
            productoRes = await r.json();
          }

          // Ahora manejamos el Stock asociado
          //  - Si exist√≠a stock, actualizamos con PUT
          //  - Si no exist√≠a, creamos con POST
          const stocksR = await fetch(`${BACKEND_URL}/ventas/stocks/?producto=${prodId}`, {
            method: "GET",
            headers,
          });
          const stocksData = await stocksR.json();

          if (stocksData.length > 0) {
            // Actualizar stock
            const stockId = stocksData[0].id;
            await fetch(`${BACKEND_URL}/ventas/stocks/${stockId}/`, {
              method: "PUT",
              headers,
              body: JSON.stringify({ producto: prodId, cantidad: stockCantidad }),
            });
          } else {
            // Crear stock nuevo
            await fetch(`${BACKEND_URL}/ventas/stocks/`, {
              method: "POST",
              headers,
              body: JSON.stringify({ producto: prodId, cantidad: stockCantidad }),
            });
          }

          // Cerrar modal y recargar lista
          cerrarModal();
          cargarInventario();
        } catch (err) {
          console.error(err);
          alert("Error al guardar producto.");
        }
      });

      // Al cargar la p√°gina, verificar acceso y obtener el inventario
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAccess();
        cargarInventario();
        searchInput.addEventListener("input", filterTable);
        
        // Inicializar Lucide icons
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      });

      async function checkAccess() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/";
          return;
        }

        try {
          const resp = await fetch(`${BACKEND_URL}/ventas/user/me/`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          
          if (!resp.ok) {
            localStorage.removeItem("token");
            window.location.href = "/";
            return;
          }
          
          const user = await resp.json();
          
          // Mostrar informaci√≥n del usuario
          document.getElementById("userInfo").textContent = `${user.first_name} ${user.last_name} (${user.role})`;
          
          // Si es empleado, mostrar mensaje de acceso denegado
          if (user.role === 'EMPLOYEE') {
            document.getElementById("accessDenied").classList.remove("hidden");
            // Inicializar √≠conos en el mensaje de acceso denegado
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            return;
          }
          
        } catch (err) {
          console.error("Error al verificar acceso:", err);
          window.location.href = "/";
        }
      }
    </script>
  </body>
</html>