<!-- frontend-node/public/pos.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Punto de Venta ‚Äì ManuMarket</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Chart.js para los gr√°ficos (igual que dashboard, aunque no se use aqu√≠) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      /* Animaciones personalizadas */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
      }
      .animate-slide-in {
        animation: slideIn 0.5s ease-out;
      }
      .animate-pulse-custom {
        animation: pulse 2s infinite;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      /* Gradiente personalizado */
      .bg-gradient-custom {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e40af 100%);
      }
      .bg-gradient-card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
      }
      /* Efectos de vidrio */
      .glass-effect {
        backdrop-filter: blur(16px);
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
      .glass-card {
        backdrop-filter: blur(8px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      /* Efectos hover */
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      /* Loader/Spinner personalizado */
      .loader-overlay {
        backdrop-filter: blur(8px);
        background: linear-gradient(135deg, rgba(15,23,42,0.85) 0%, rgba(30,41,59,0.85) 100%);
      }
      .loader-spinner {
        width: 5rem;
        height: 5rem;
        border: 6px solid rgba(59,130,246,0.25); /* azul transl√∫cido */
        border-top: 6px solid #3b82f6; /* azul fuerte */
        border-right: 6px solid #fff6; /* blanco transl√∫cido */
        border-radius: 50%;
        box-shadow: 0 4px 32px 0 #1e293b99;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
      }
      .loader-text {
        color: #3b82f6;
        font-weight: 600;
        font-size: 1.15rem;
        letter-spacing: 0.02em;
        text-align: center;
        animation: fadeIn 1.2s;
        text-shadow: 0 2px 8px #1e293b88;
      }
      /* Modal de √©xito moderno */
      .modal-overlay {
        backdrop-filter: blur(10px);
        background: linear-gradient(135deg, rgba(15,23,42,0.85) 0%, rgba(30,41,59,0.85) 100%);
      }
      .modal-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.98) 100%);
        border: 1.5px solid rgba(59,130,246,0.25);
        border-radius: 1.25rem;
        box-shadow: 0 8px 40px 0 #1e293bcc, 0 1.5px 0 #3b82f6;
        padding: 2.5rem 2rem 2rem 2rem;
        min-width: 320px;
        max-width: 95vw;
        animation: fadeIn 0.7s cubic-bezier(.4,2,.6,1) 1;
        position: relative;
      }
      .modal-success-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.2rem;
      }
      .modal-success-icon svg, .modal-success-icon i {
        width: 3.5rem;
        height: 3.5rem;
        color: #22c55e;
        filter: drop-shadow(0 0 16px #22c55e88);
        animation: popIn 0.5s cubic-bezier(.4,2,.6,1);
      }
      @keyframes popIn {
        0% { transform: scale(0.5); opacity: 0; }
        80% { transform: scale(1.15); opacity: 1; }
        100% { transform: scale(1); }
      }
      .modal-title {
        color: #fff;
        font-size: 1.45rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
        letter-spacing: 0.01em;
      }
      .modal-message {
        color: #cbd5e1;
        font-size: 1.08rem;
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .modal-close {
        position: absolute;
        top: 1.1rem;
        right: 1.1rem;
        color: #64748b;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }
      .modal-close:hover {
        color: #fff;
      }
      .modal-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.85rem 0;
        background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
        color: #fff;
        font-weight: 600;
        font-size: 1.08rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 12px #1e40af55;
        border: 1.5px solid #3b82f6cc;
        transition: background 0.2s, box-shadow 0.2s;
      }
      .modal-btn:hover {
        background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
        box-shadow: 0 4px 24px #1e40af88;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-custom">
    <!-- Barra de navegaci√≥n moderna -->
    <nav class="glass-effect border-b border-white/10 animate-slide-in">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20 items-center">
          <!-- Logo y brand -->
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 bg-blue-600 p-3 rounded-xl shadow-lg">
              <i data-lucide="shopping-cart" class="w-7 h-7 text-white"></i>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-white">ManuMarket</h1>
              <p class="text-sm text-slate-300">Punto de Venta</p>
            </div>
          </div>

          <!-- Navigation Links Desktop -->
          <div id="navigationLinks" class="hidden md:flex md:space-x-2">
            <a href="/dashboard" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a id="inventarioLink" href="/inventario" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>Inventario</span>
            </a>
            <a href="/pos" class="inline-flex items-center px-5 py-3 rounded-xl bg-blue-600/30 text-white font-semibold text-base border border-blue-500/50 space-x-2 shadow-lg">
              <i data-lucide="shopping-bag" class="w-5 h-5"></i>
              <span>POS</span>
            </a>
            <a href="/historial-ventas" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="history" class="w-5 h-5"></i>
              <span>Historial</span>
            </a>
            <a id="trabajadoresLink" href="/trabajadores" class="inline-flex items-center px-5 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base transition-all duration-200 space-x-2">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Trabajadores</span>
            </a>
          </div>

          <!-- User info y logout -->
          <div class="flex items-center space-x-5">
            <div class="text-right hidden sm:block">
              <p id="userInfo" class="text-base font-bold text-white">‚Äî</p>
              <p class="text-sm text-slate-200">Bienvenido</p>
            </div>
            <a href="/logout" class="inline-flex items-center px-5 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base transition-all duration-200 space-x-2 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Salir</span>
            </a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden">
            <button id="btnMenu" class="inline-flex items-center justify-center p-3 rounded-xl text-white hover:text-white hover:bg-white/20 transition-all duration-200">
              <i data-lucide="menu" class="w-7 h-7"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <div id="menuResponsive" class="md:hidden hidden border-t border-white/10 bg-slate-900/50">
        <div class="px-4 pt-2 pb-3 space-y-1">
          <a href="/dashboard" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
          <a id="inventarioLinkMobile" href="/inventario" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span>Inventario</span>
          </a>
          <a href="/pos" class="flex items-center px-4 py-3 rounded-xl bg-blue-600/30 text-white font-bold text-base space-x-3 border border-blue-500/50 shadow-lg">
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span>POS</span>
          </a>
          <a href="/historial-ventas" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="history" class="w-5 h-5"></i>
            <span>Historial de Ventas</span>
          </a>
          <a id="trabajadoresLinkMobile" href="/trabajadores" class="flex items-center px-4 py-3 rounded-xl text-white hover:bg-white/20 hover:text-white font-semibold text-base space-x-3 transition-all duration-200">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span>Trabajadores</span>
          </a>
          <div class="border-t border-white/10 pt-3 mt-3">
            <div class="px-4 py-2">
              <p id="userInfoMobile" class="text-base font-bold text-white">‚Äî</p>
            </div>
            <a href="/logout" class="flex items-center px-4 py-3 rounded-xl bg-red-600/30 text-white hover:bg-red-600/50 hover:text-white font-semibold text-base space-x-3 transition-all duration-200 border border-red-500/50">
              <i data-lucide="log-out" class="w-5 h-5"></i>
              <span>Cerrar sesi√≥n</span>
            </a>
          </div>
        </div>
      </div>
    </nav>
    <script>
      const btnMenu = document.getElementById("btnMenu");
      const menuResponsive = document.getElementById("menuResponsive");
      btnMenu && btnMenu.addEventListener("click", () => {
        menuResponsive.classList.toggle("hidden");
      });
      // Inicializar iconos
      lucide.createIcons();
    </script>
    <!-- ================================ -->

    <!-- CONTENIDO: PUNTO DE VENTA / CARRITO -->
    <main class="max-w-4xl mx-auto py-6 animate-fade-in">
      <div class="glass-card rounded-2xl p-6 card-hover">
        <h1 class="text-2xl font-bold text-white mb-4">Punto de Venta</h1>

        <!-- BLOQUE DE AGREGAR PRODUCTO (con contenedor de sugerencias) -->
        <div class="flex items-center mb-4 relative">
          <div class="relative flex-grow">
            <input
              id="inputBuscar"
              type="text"
              placeholder="C√≥digo o nombre de producto"
              autocomplete="off"
              class="w-full pl-10 pr-4 py-2 border border-blue-800/30 bg-slate-900/60 text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"
            />
            <!-- √çcono de lupa -->
            <svg
              class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-4.35-4.35M16.65 16.65A7 7 0 1110 3a7 7 0 016.65 13.65z"
              />
            </svg>
            <div
              id="contenedorSugerencias"
              class="absolute z-10 w-full bg-slate-900/90 border border-blue-800/30 rounded-b-lg shadow-lg mt-1 hidden max-h-60 overflow-auto text-white"
            ></div>
          </div>
          <button
            id="btnAgregar"
            class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2 shadow-lg transition-all duration-200"
          >
            <i data-lucide="plus-circle" class="w-5 h-5"></i>
            <span>Agregar</span>
          </button>
        </div>

        <!-- BLOQUE DE DESCUENTOS -->
        <div class="bg-gradient-card p-4 mb-4 rounded-lg shadow">
          <label for="inputDescuentoClp" class="block text-slate-300 font-medium mb-2">
            Descuento de la venta (en CLP):
          </label>
          <input
            id="inputDescuentoClp"
            type="number"
            step="0.01"
            value="0"
            min="0"
            class="w-full border border-blue-800/30 bg-slate-900/60 text-white placeholder:text-slate-400 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-slate-400 mb-4">Si no deseas descuento en CLP, deja en cero.</p>

          <label for="inputDescuentoPct" class="block text-slate-300 font-medium mb-2">
            Descuento porcentual (%):
          </label>
          <input
            id="inputDescuentoPct"
            type="number"
            step="0.01"
            value="0"
            min="0"
            max="100"
            class="w-full border border-blue-800/30 bg-slate-900/60 text-white placeholder:text-slate-400 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-xs text-slate-400 mt-1">Ingresa un porcentaje (ej. ‚Äú10‚Äù = 10 %).</p>
        </div>

        <!-- TABLA DE √çTEMS DEL CARRITO -->
        <div id="contenedorTabla" class="border border-blue-800/30 rounded-lg overflow-hidden bg-slate-900/80">
          <div class="grid grid-cols-12 bg-slate-800/80 p-3 font-medium text-slate-300">
            <div class="col-span-2">C√≥digo</div>
            <div class="col-span-3">Producto</div>
            <div class="col-span-1 text-center">Stock</div>
            <div class="col-span-2 text-right">Precio U.</div>
            <div class="col-span-2 text-right">Subtotal</div>
            <div class="col-span-2 text-center">Cantidad</div>
            <div class="col-span-1"></div>
          </div>
          <div id="cuerpoTabla"></div>
        </div>

        <!-- BLOQUE DE TOTALES -->
        <div class="flex justify-end mt-4">
          <div class="w-full md:w-1/2 lg:w-1/3 p-4">
            <div class="flex justify-between mb-2">
              <span class="font-medium text-slate-300">Total (sin descuento):</span>
              <span id="spanTotal" class="font-semibold text-white">‚Ç±0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-300">Total final (con descuentos):</span>
              <span id="spanTotalFinal" class="font-semibold text-green-400">‚Ç±0.00</span>
            </div>
          </div>
        </div>

        <!-- BOT√ìN COMPRAR -->
        <div class="flex justify-end mb-8">
          <button
            id="btnComprar"
            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center space-x-2 transition-all duration-200"
          >
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
            <span>Comprar</span>
          </button>
        </div>
      </div>
    </main>

<!-- Modal de confirmaci√≥n -->
<div id="miModal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay">
  <div class="modal-card animate-fade-in">
    <button onclick="cerrarModal()" class="modal-close" aria-label="Cerrar">&times;</button>
    <div class="modal-success-icon">
      <i data-lucide="check-circle"></i>
    </div>
    <h3 class="modal-title" id="modalTitulo">Resultado de la Venta</h3>
    <p class="modal-message" id="modalMensaje"></p>
    <button onclick="cerrarModal()" class="modal-btn">
      <i data-lucide="check-circle" class="w-5 h-5"></i>
      <span>Aceptar</span>
    </button>
  </div>
</div>

<!-- Spinner de carga -->
<div id="spinner" class="hidden fixed inset-0 flex items-center justify-center z-50 loader-overlay">
  <div class="flex flex-col items-center">
    <div class="loader-spinner"></div>
    <div class="loader-text animate-fade-in">Procesando venta‚Ä¶</div>
  </div>
</div>


    <!-- SCRIPT DE INTERACTIVIDAD DEL CARRITO -->
    <script>
      // 1) Estado local del carrito
      let carritoItems = [];

      // Agregar variable global para almacenar datos del usuario
let usuarioActual = null;

// Funci√≥n para obtener datos del usuario actual
async function obtenerUsuarioActual() {
    try {
        const response = await fetch('/api/usuario-actual/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            usuarioActual = await response.json();
            console.log('Usuario actual:', usuarioActual);
        } else {
            console.error('Error al obtener usuario actual');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Llamar la funci√≥n al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    obtenerUsuarioActual();
    // ...existing code...
});

      // 2) Referencias a elementos DOM
      const inputBuscar = document.getElementById("inputBuscar");
      const btnAgregar = document.getElementById("btnAgregar");
      const cuerpoTabla = document.getElementById("cuerpoTabla");
      const spanTotal = document.getElementById("spanTotal");
      const spanTotalFinal = document.getElementById("spanTotalFinal");

      // ** Ahora tenemos DOS inputs de descuento **
      const inputDescuentoClp = document.getElementById("inputDescuentoClp");
      const inputDescuentoPct = document.getElementById("inputDescuentoPct");

      const btnComprar = document.getElementById("btnComprar");

      // ** NUEVA REFERENCIA PARA SUGERENCIAS **
      const contenedorSugerencias = document.getElementById("contenedorSugerencias");

      // 3) URL base del backend Django
      const BACKEND_URL = "http://localhost:8000";
      const token = localStorage.getItem("token");
      const headers = token
        ? { "Content-Type": "application/json", "Authorization": `Bearer ${token}` }
        : { "Content-Type": "application/json" };

      // 4) Formatear moneda (CLP)
      function formatearMoneda(valor) {
        return new Intl.NumberFormat("es-CL", { style: "currency", currency: "CLP" }).format(valor);
      }

      // 5) Calcular totales y actualizar UI (incluye descuentos CLP + %)
      function actualizarTotales() {
        // Total bruto
        const total = carritoItems.reduce((acc, item) => acc + item.precio * item.cantidad, 0);

        // 1) Descuento en CLP
        let descuentoClp = parseFloat(inputDescuentoClp.value) || 0;
        if (descuentoClp < 0) descuentoClp = 0;

        // 2) Descuento porcentual
        let pct = parseFloat(inputDescuentoPct.value) || 0;
        if (pct < 0) pct = 0;
        if (pct > 100) pct = 100;

        // 3) Monto de descuento porcentual
        const descuentoPctMonto = (total * pct) / 100;

        // 4) Total final
        let totalFinal = total - descuentoClp - descuentoPctMonto;
        if (totalFinal < 0) totalFinal = 0;

        // 5) Actualizar UI
        spanTotal.textContent = formatearMoneda(total);
        spanTotalFinal.textContent = formatearMoneda(totalFinal);
      }

      // 6) Renderizar carrito (ahora con columna Stock)
      function renderizarCarrito() {
        cuerpoTabla.innerHTML = "";

        carritoItems.forEach((item, index) => {
          const subtotal = item.precio * item.cantidad;

          const fila = document.createElement("div");
          fila.className = "grid grid-cols-12 p-3 items-center hover:bg-blue-900/30 border-t border-blue-800/30 bg-slate-900/70 transition-colors duration-150";

          // 1) C√≥digo
          const divCodigo = document.createElement("div");
          divCodigo.className = "col-span-2 font-mono text-sm text-slate-200";
          divCodigo.textContent = item.codigo;
          fila.appendChild(divCodigo);

          // 2) Nombre
          const divNombre = document.createElement("div");
          divNombre.className = "col-span-3 text-white";
          divNombre.textContent = item.nombre;
          fila.appendChild(divNombre);

          // 3) Stock actual
          const divStock = document.createElement("div");
          divStock.className = "col-span-1 text-center font-mono text-sm text-slate-400";
          divStock.textContent = item.stock;
          fila.appendChild(divStock);

          // 4) Precio unitario
          const divPrecio = document.createElement("div");
          divPrecio.className = "col-span-2 text-right font-medium text-blue-400";
          divPrecio.textContent = formatearMoneda(item.precio);
          fila.appendChild(divPrecio);

          // 5) Subtotal
          const divSubtotal = document.createElement("div");
          divSubtotal.className = "col-span-2 text-right font-medium text-green-400";
          divSubtotal.textContent = formatearMoneda(subtotal);
          fila.appendChild(divSubtotal);

          // 6) Controles cantidad
          const divCantCont = document.createElement("div");
          divCantCont.className = "col-span-2 flex justify-center";
          const divCantInner = document.createElement("div");
          divCantInner.className = "flex items-center bg-slate-800/80 rounded-lg overflow-hidden border border-blue-800/30";

          // Bot√≥n ‚Äú‚Äì‚Äù
          const btnMinus = document.createElement("button");
          btnMinus.className = "w-8 h-8 bg-slate-900/80 hover:bg-blue-800/40 text-white border-r border-blue-800/30 focus:outline-none";
          btnMinus.textContent = "-";
          btnMinus.onclick = () => {
            if (item.cantidad > 1) {
              item.cantidad--;
            } else {
              carritoItems.splice(index, 1);
            }
            renderizarCarrito();
            actualizarTotales();
          };
          divCantInner.appendChild(btnMinus);

          // Cantidad
          const divCantValor = document.createElement("div");
          divCantValor.className = "w-10 h-8 flex items-center justify-center text-white font-bold";
          divCantValor.textContent = item.cantidad;
          divCantInner.appendChild(divCantValor);

          // Bot√≥n ‚Äú+‚Äù
          const btnPlus = document.createElement("button");
          btnPlus.className = "w-8 h-8 bg-slate-900/80 hover:bg-blue-800/40 text-white border-l border-blue-800/30 focus:outline-none";
          btnPlus.textContent = "+";
          btnPlus.onclick = () => {
            item.cantidad++;
            renderizarCarrito();
            actualizarTotales();
          };
          divCantInner.appendChild(btnPlus);

          divCantCont.appendChild(divCantInner);
          fila.appendChild(divCantCont);

          // 7) Bot√≥n eliminar
          const divEliminar = document.createElement("div");
          divEliminar.className = "col-span-1 flex justify-end";
          const btnEliminar = document.createElement("button");
          btnEliminar.className = "text-red-400 hover:text-red-600 p-1 transition-colors duration-150";
          btnEliminar.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138
                   21H7.862a2 2 0 01-1.995-1.858L5
                   7m5 4v6m4-6v6m1-10V4a1 1 0
                   00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              ></path>
            </svg>
          `;
          btnEliminar.onclick = () => {
            carritoItems.splice(index, 1);
            renderizarCarrito();
            actualizarTotales();
          };
          divEliminar.appendChild(btnEliminar);
          fila.appendChild(divEliminar);

          cuerpoTabla.appendChild(fila);
        });
      }

      // Funci√≥n para actualizar el stock de los productos despu√©s de una venta
      async function actualizarStockProductos() {
        try {
          // Obtener todos los productos actualizados
          const resp = await fetch(`${BACKEND_URL}/ventas/productos/`, {
            method: "GET",
            headers,
          });
          if (!resp.ok) throw new Error("Error al cargar productos");
          
          const productosActualizados = await resp.json();
          
          // Actualizar el stock en el carrito con los datos m√°s recientes
          carritoItems.forEach(item => {
            const productoActualizado = productosActualizados.find(p => p.codigo === item.codigo);
            if (productoActualizado) {
              item.stock = productoActualizado.stock;
            }
          });
          
          // Re-renderizar el carrito con los stocks actualizados
          renderizarCarrito();
        } catch (err) {
          console.error("Error al actualizar stock:", err);
        }
      }      // 7) Agregar producto al carrito (solo con coincidencia exacta)
      btnAgregar.onclick = async () => {
        const codigoBuscado = inputBuscar.value.trim();
        if (!codigoBuscado) {
          alert("Ingresa un c√≥digo o nombre de producto.");
          return;
        }

        try {
          const resp = await fetch(
            `${BACKEND_URL}/ventas/productos/?codigo=${encodeURIComponent(codigoBuscado)}`,
            {
              method: "GET",
              headers,
            }
          );
          if (!resp.ok) throw new Error("Error al buscar producto");

          const productos = await resp.json();
          if (productos.length === 0) {
            alert("Producto no encontrado.");
            return;
          }

          // ‚Äî‚Äî‚Äî> BUSCAR COINCIDENCIA EXACTA (por c√≥digo o por nombre)
          let prod = productos.find(
            (p) =>
              p.codigo.toString().toLowerCase() === codigoBuscado.toLowerCase() ||
              p.nombre.toLowerCase() === codigoBuscado.toLowerCase()
          );
            // Si NO hay coincidencia exacta, no agregar nada
          if (!prod) {
            // Verificar si hay productos similares para dar sugerencias
            const similares = productos.filter(p => 
              p.nombre.toLowerCase().includes(codigoBuscado.toLowerCase()) ||
              p.codigo.toString().includes(codigoBuscado)
            );
            
            if (similares.length > 0) {
              const sugerencia = similares[0];
              alert(`‚ùå No se encontr√≥ coincidencia exacta para "${codigoBuscado}".\n\nüí° ¬øQuiz√°s buscabas?\n‚Ä¢ ${sugerencia.nombre} (C√≥digo: ${sugerencia.codigo})\n\nUsa el autocompletado o escribe el c√≥digo/nombre exacto.`);
            } else {
              alert(`‚ùå No se encontr√≥ ning√∫n producto con "${codigoBuscado}".\n\nüí° Verifica:\n‚Ä¢ El c√≥digo de barras\n‚Ä¢ El nombre del producto\n‚Ä¢ Que el producto est√© registrado en el sistema`);
            }
            return;
          }

          const existe = carritoItems.find((p) => p.codigo === prod.codigo);
          if (existe) {
            existe.cantidad++;
          } else {
            carritoItems.push({
              codigo: prod.codigo,
              nombre: prod.nombre,
              precio: parseFloat(prod.precio),
              stock: prod.stock,
              cantidad: 1,
            });
          }

          inputBuscar.value = "";
          contenedorSugerencias.classList.add("hidden"); // Ocultar sugerencias
          renderizarCarrito();
          actualizarTotales();
        } catch (err) {
          console.error(err);
          alert("Error al agregar producto.");
        }
      };

      // 8) Comprar: crear y confirmar transacci√≥n
      btnComprar.onclick = async () => {
        if (carritoItems.length === 0) {
          mostrarModal("Carrito vac√≠o","Nohay existencias para vender");
          return;
        }

        AbrirModal();


        const itemsParaEnviar = carritoItems.map((item) => ({
          codigo: item.codigo,
          cantidad: item.cantidad,
        }));
        const descuentoValor = parseFloat(inputDescuentoClp.value) || 0;
        const pctValor = parseFloat(inputDescuentoPct.value) || 0;

        const body = {
          descuento_carrito: descuentoValor,
          porcentaje_descuento: pctValor,
          items: itemsParaEnviar,
        };

        try {
          // 8.1) Crear transacci√≥n
          const respCrear = await fetch(`${BACKEND_URL}/ventas/transacciones/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          });
          if (!respCrear.ok) {
            const errorJson = await respCrear.json();
            alert("Error al crear transacci√≥n:\n" + JSON.stringify(errorJson));
            return;
          }
          const transaccionData = await respCrear.json();
          const transaccionId = transaccionData.id;

          // 8.2) Confirmar transacci√≥n
          const respConfirm = await fetch(
            `${BACKEND_URL}/ventas/transacciones/${transaccionId}/confirmar/`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );
          
          if (!respConfirm.ok) {
            const errJson = await respConfirm.json();
            
            // Verificar si es un error de permisos espec√≠fico para empleados
            if (respConfirm.status === 403 && errJson.tipo_error === 'STOCK_INSUFICIENTE_EMPLEADO') {
              mostrarModalErrorVenta(errJson);
              return;
            }
            
            // Para otros errores
            alert("Error al confirmar transacci√≥n:\n" + JSON.stringify(errJson));
            return;
          }
          const resultado = await respConfirm.json();          // 8.3) Mostrar resultado
          if (resultado.estado === "CONFIRMADA") {
            mostrarModal("¬°Venta exitosa", `Transacci√≥n confirmada correctamente!`);
          } else {
            mostrarModal("¬°Venta exitosa", `Transacci√≥n confirmada correctamente!`);
          }

          // Guardar informaci√≥n completa de la compra incluyendo descuentos
          const totalSinDescuento = carritoItems.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
          const descuentoClp = parseFloat(inputDescuentoClp.value) || 0;
          const descuentoPct = parseFloat(inputDescuentoPct.value) || 0;
          const descuentoPctMonto = (totalSinDescuento * descuentoPct) / 100;
          const totalFinal = totalSinDescuento - descuentoClp - descuentoPctMonto;

          const datosCompra = {
            productos: carritoItems,
            totalSinDescuento: totalSinDescuento,
            descuentoClp: descuentoClp,
            descuentoPorcentaje: descuentoPct,
            descuentoPorcentajeMonto: descuentoPctMonto,
            totalDescuentos: descuentoClp + descuentoPctMonto,
            totalFinal: totalFinal,
            fecha: new Date().toISOString()
          };

          localStorage.setItem('ultimaCompra', JSON.stringify(datosCompra));

          // Actualizar el stock de los productos despu√©s de la venta
          await actualizarStockProductos();

          // Limpiar carrito
          carritoItems = [];
          inputDescuentoClp.value = 0;
          inputDescuentoPct.value = 0;
          renderizarCarrito();
          actualizarTotales();
        } catch (err) {
          console.error(err);
          mostrarModal("Error en el proceso de compra.");
        }finally {
    // Ocultar spinner (por si acaso)
    document.getElementById("spinner").classList.add("hidden");
  }
      };
      // Funci√≥n para mostrar el modal con mensajes personalizados
function mostrarModal(titulo, mensaje) {
  document.getElementById("modalTitulo").textContent = titulo;
  document.getElementById("modalMensaje").textContent = mensaje;
  document.getElementById("miModal").classList.remove("hidden");
}

// Tus funciones existentes de modal
function AbrirModal() {
  document.getElementById("spinner").classList.remove("hidden");
  document.getElementById("miModal").classList.add("hidden");
}

function cerrarModal() {
  document.getElementById("miModal").classList.add("hidden");
   setTimeout(() => {
      window.location.href = "compras.html";
    }, 200);
}

// Funci√≥n para mostrar modal de error espec√≠fico para empleados
function mostrarModalErrorVenta(errorData) {
    let mensaje = `‚ùå VENTA NO AUTORIZADA\n\n`;
    mensaje += `${errorData.detalle}\n\n`;
    
    if (errorData.items_sin_stock && errorData.items_sin_stock.length > 0) {
        mensaje += `Productos con stock insuficiente:\n`;
        errorData.items_sin_stock.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto} (C√≥digo: ${item.codigo})\n`;
            mensaje += `  Stock disponible: ${item.stock_disponible}\n`;
            mensaje += `  Cantidad solicitada: ${item.cantidad_solicitada}\n\n`;
        });
    }
    
    mensaje += `Contacta a un administrador para realizar esta venta.`;
    
    alert(mensaje);
}

      // 9) Inicializar al cargar
      document.addEventListener("DOMContentLoaded", () => {
        renderizarCarrito();
        actualizarTotales();
      });

      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      // AUTOCOMPLETADO DE PRODUCTOS
      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

      let timeoutId = null;

      function debounce(fn, delay) {
        return function (...args) {
          if (timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            fn.apply(this, args);
          }, delay);
        };
      }      async function buscarSugerencias(texto) {
        if (!texto || texto.length < 2) {
          contenedorSugerencias.innerHTML = "";
          contenedorSugerencias.classList.add("hidden");
          return;
        }

        try {
          const resp = await fetch(
            `${BACKEND_URL}/ventas/productos/`,
            { method: "GET", headers }
          );
          if (!resp.ok) throw new Error("Error al buscar sugerencias");

          const productos = await resp.json();
          const txt = texto.toLowerCase();
          
          // Filtrar productos que contengan el texto en nombre o c√≥digo
          const filtrados = productos.filter((p) => {
            return (
              p.nombre.toLowerCase().includes(txt) ||
              p.codigo.toString().toLowerCase().includes(txt)
            );
          }).slice(0, 8); // Limitar a 8 resultados para mejor rendimiento

          renderizarSugerencias(filtrados, texto);
        } catch (err) {
          console.error("Error en buscarSugerencias:", err);
          contenedorSugerencias.innerHTML = "";
          contenedorSugerencias.classList.add("hidden");
        }
      }

      function renderizarSugerencias(lista, textoBuscado) {
        contenedorSugerencias.innerHTML = "";

        if (lista.length === 0) {
          // Mostrar mensaje cuando no hay resultados
          const noResults = document.createElement("div");
          noResults.className = "px-4 py-3 text-sm text-gray-500 text-center";
          noResults.textContent = `No se encontraron productos que contengan "${textoBuscado}"`;
          contenedorSugerencias.appendChild(noResults);
          contenedorSugerencias.classList.remove("hidden");
          return;
        }

        lista.forEach((prod) => {
          const item = document.createElement("div");
          item.className =
            "px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0";
          
          // Highlight del texto coincidente
          const nombreHighlight = highlightText(prod.nombre, textoBuscado);
          const codigoHighlight = highlightText(prod.codigo.toString(), textoBuscado);
          
          item.innerHTML = `
            <div class="flex justify-between items-center">
              <span>${nombreHighlight}</span>
              <div class="text-right">
                <span class="text-gray-500 font-mono text-xs">${codigoHighlight}</span>
                <br>
                <span class="text-green-600 font-medium">${formatearMoneda(prod.precio)}</span>
              </div>
            </div>
          `;
          
          item.addEventListener("click", () => {
            // Inyectar el C√ìDIGO exacto en el input para garantizar coincidencia
            inputBuscar.value = prod.codigo.toString();
            contenedorSugerencias.classList.add("hidden");
            // Opcional: agregar autom√°ticamente al hacer clic
            // btnAgregar.click();
          });
          contenedorSugerencias.appendChild(item);
        });

        contenedorSugerencias.classList.remove("hidden");
      }

      // Funci√≥n auxiliar para resaltar texto coincidente
      function highlightText(text, searchText) {
        if (!searchText) return text;
        const regex = new RegExp(`(${searchText})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
      }      inputBuscar.addEventListener(
        "input",
        debounce((e) => {
          const texto = e.target.value.trim();
          buscarSugerencias(texto);
        }, 300)
      );

      // Agregar funcionalidad con Enter
      inputBuscar.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          btnAgregar.click();
        }
      });

      document.addEventListener("click", (e) => {
        if (
          !inputBuscar.contains(e.target) &&
          !contenedorSugerencias.contains(e.target)
        ) {
          contenedorSugerencias.classList.add("hidden");
        }
      });

      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      // FIN AUTOCOMPLETADO
      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      // ESCUCHAR CAMBIOS EN DESCUENTOS
      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      inputDescuentoClp.addEventListener("input", () => {
        actualizarTotales();
      });
      inputDescuentoPct.addEventListener("input", () => {
        actualizarTotales();
      });      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      // FIN ESCUCHAR CAMBIOS EN DESCUENTOS
      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      // CONTROL DE ACCESO POR ROL
      //‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      async function setupAccessControl() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/";
          return;
        }

        try {
          const resp = await fetch(`${BACKEND_URL}/ventas/user/me/`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          
          if (!resp.ok) {
            localStorage.removeItem("token");
            window.location.href = "/";
            return;
          }
            const user = await resp.json();
          
          // Mostrar informaci√≥n del usuario
          document.getElementById("userInfo").textContent = `${user.first_name} ${user.last_name} (${user.role})`;
          
          // Si es empleado, ocultar enlaces de inventario y usuarios
          if (user.role === 'EMPLOYEE') {
            const inventarioLink = document.getElementById("inventarioLink");
            const trabajadoresLink = document.getElementById("trabajadoresLink");
            const inventarioLinkMobile = document.getElementById("inventarioLinkMobile");
            const trabajadoresLinkMobile = document.getElementById("trabajadoresLinkMobile");
            
            if (inventarioLink) inventarioLink.style.display = "none";
            if (trabajadoresLink) trabajadoresLink.style.display = "none";
            if (inventarioLinkMobile) inventarioLinkMobile.style.display = "none";
            if (trabajadoresLinkMobile) trabajadoresLinkMobile.style.display = "none";
          }
          
        } catch (err) {
          console.error("Error al verificar acceso:", err);
          window.location.href = "/";
        }
      }

      // Ejecutar control de acceso al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", () => {
        setupAccessControl();
      });

    </script>
    <!-- Inicializar iconos Lucide (igual que dashboard) -->
    <script>
      lucide.createIcons();
    </script>
  </body>
</html>
