{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Productos{% endblock %}

{% block content %}
<h1>Lista de Productos</h1>
{% if perms.inv.add_producto %}
<button id="add-product-btn">Añadir Producto</button>
{% endif %}
<input type="text" id="search-field" placeholder="Buscar por nombre o código de barras...">

<div id="product-list">
    {% for producto in productos %}
        <div class="product-item" data-product-id="{{ producto.id }}">
            <strong>{{ producto.nombre }}</strong><br>
            Código de barras: {{ producto.codigo_barras }}<br>
            Precio: ${{ producto.precio }}<br>
            Existencias: {{ producto.total_stock }}<br>
            Sección: {{ producto.seccion.nombre }}<br>
            Subsección: {{ producto.subseccion.nombre }}<br>
            Ubicaciones:
            <ul>
                {% for inventario in producto.inventarios.all %}
                    <li>{{ inventario.ubicacion.nombre }} (Cantidad: {{ inventario.cantidad }})</li>
                {% empty %}
                    <li>No hay ubicaciones disponibles.</li>
                {% endfor %}
            </ul>
            <!-- Botones de acción -->
            {% if perms.inv.change_producto %}
            <button class="edit-product-btn">Editar</button>
            {% endif %}
            {% if perms.inv.delete_producto %}
            <button class="delete-product-btn">Eliminar</button>
            {% endif %}
            {% if perms.inv.change_inventario %}
            <button class="move-product-btn">Mover</button>
            {% endif %}
        </div>
    {% empty %}
        <p>No hay productos disponibles.</p>
    {% endfor %}
</div>

<!-- Modales -->
<div id="modal-container"></div>
{% endblock %}

{% block extra_js %}
<!-- Incluye el JavaScript para la funcionalidad de búsqueda y CRUD -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchField = document.getElementById('search-field');
    const productList = document.getElementById('product-list');
    const modalContainer = document.getElementById('modal-container');

    // Función para cargar el modal
    function loadModal(url) {
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            modalContainer.innerHTML = html;
            // Mostrar el modal
            const modal = modalContainer.querySelector('.modal');
            modal.style.display = 'block';

            // Agregar eventos al formulario del modal
            const form = modal.querySelector('form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                fetch(form.action, {
                    method: form.method,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Cerrar el modal y recargar la lista de productos
                        modal.style.display = 'none';
                        modalContainer.innerHTML = '';
                        loadProductList();
                    } else {
                        // Mostrar errores en el formulario
                        const errorsDiv = modal.querySelector('.errors');
                        let errorsHtml = '';

                        if (data.errors) {
                            errorsHtml += '<p>Errores en el formulario:</p>';
                            const formErrors = JSON.parse(data.errors);
                            for (const field in formErrors) {
                                errorsHtml += `<p>${field}: ${formErrors[field].map(error => error.message).join(', ')}</p>`;
                            }
                        }
                        if (data.formset_errors) {
                            errorsHtml += '<p>Errores en el inventario:</p>';
                            data.formset_errors.forEach(function(error, index) {
                                if (Object.keys(error).length > 0) {
                                    errorsHtml += `<p>Fila ${index + 1}:</p>`;
                                    for (const field in error) {
                                        errorsHtml += `<p>${field}: ${error[field]}</p>`;
                                    }
                                }
                            });
                        }
                        errorsDiv.innerHTML = errorsHtml;
                    }
                });
            });

            // Agregar evento para cerrar el modal
            const closeModalBtn = modal.querySelector('.close-modal');
            closeModalBtn.addEventListener('click', function() {
                modal.style.display = 'none';
                modalContainer.innerHTML = '';
            });

            // Asignar eventos para añadir filas en el inventario (si es necesario)
            const addInventarioRowBtn = modal.querySelector('#add-inventario-row');
            if (addInventarioRowBtn) {
                addInventarioRowBtn.addEventListener('click', function() {
                    var totalForms = modal.querySelector('#id_inventario_set-TOTAL_FORMS');
                    var currentFormCount = parseInt(totalForms.value);
                    var emptyRow = modal.querySelector('.inventario-empty-form').innerHTML.replace(/__prefix__/g, currentFormCount);
                    var table = modal.querySelector('table');
                    var newRow = document.createElement('tr');
                    newRow.innerHTML = emptyRow;
                    table.appendChild(newRow);
                    totalForms.value = currentFormCount + 1;
                });
            }

        });
    }

    // Función para cargar la lista de productos
    function loadProductList(query = '') {
        fetch(`{% url 'inv:producto_list_ajax' %}?term=${encodeURIComponent(query)}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            productList.innerHTML = html;
            // Reasignar eventos a los nuevos botones
            assignEventListeners();
        });
    }

    // Asignar eventos a los botones
    function assignEventListeners() {
        // Botón "Añadir Producto"
        const addProductBtn = document.getElementById('add-product-btn');
        if (addProductBtn) {
            addProductBtn.addEventListener('click', function() {
                loadModal('{% url "inv:producto_crear" %}');
            });
        }

        // Botones "Editar"
        document.querySelectorAll('.edit-product-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const productId = this.parentElement.getAttribute('data-product-id');
                loadModal(`{% url 'inv:producto_editar' 0 %}`.replace(0, productId));
            });
        });

        // Botones "Eliminar"
        document.querySelectorAll('.delete-product-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const productId = this.parentElement.getAttribute('data-product-id');
                loadModal(`{% url 'inv:producto_eliminar' 0 %}`.replace(0, productId));
            });
        });

        // Botones "Mover"
        document.querySelectorAll('.move-product-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const productId = this.parentElement.getAttribute('data-product-id');
                loadModal(`{% url 'inv:producto_mover' 0 %}`.replace(0, productId));
            });
        });
    }

    // Inicializar
    assignEventListeners();

    // Funcionalidad de búsqueda
    let debounceTimer;
    searchField.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = this.value;
            loadProductList(query);
        }, 300);
    });
});
</script>
{% endblock %}
