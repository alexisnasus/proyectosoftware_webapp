{% extends 'base.html' %}

{% block title %}Nueva Venta{% endblock %}

{% block content %}
<h1>Nueva Venta</h1>
<form method="post">
    {% csrf_token %}
    <div id="productos-container">
        <div class="producto-item">
            <select name="producto" class="producto-select">
                <option value="">Seleccione un producto</option>
                {% for producto in productos %}
                    <option value="{{ producto.id }}">{{ producto.nombre }} - ${{ producto.precio }}</option>
                {% endfor %}
            </select>
            <input type="number" name="cantidad" min="1" value="1" class="cantidad-input">
            <select name="ubicacion" class="ubicacion-select">
                <option value="">Seleccione una ubicación</option>
                {% for ubicacion in ubicaciones %}
                    <option value="{{ ubicacion.id }}">{{ ubicacion.nombre }}</option>
                {% endfor %}
            </select>
            <select name="producto" class="producto-select select2">
                <!-- opciones -->
            </select>            
            <span class="stock-info">Existencias: <span class="stock-cantidad">-</span></span>
            <button type="button" class="remove-item">Eliminar</button>
        </div>
    </div>
    <button type="button" id="add-producto">Añadir Producto</button>
    <button type="submit">Procesar Venta</button>
</form>

{% endblock %}

{% block extra_js %}
<script>

    $(document).ready(function() {
        function initSelect2() {
            $('.producto-select').select2({
                placeholder: 'Seleccione un producto',
                ajax: {
                    url: '{% url "inv:buscar_productos_autocomplete" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term,
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data.results,
                        };
                    },
                    cache: true,
                },
                minimumInputLength: 1,
                templateResult: formatProducto,
                templateSelection: formatProductoSelection,
            });
        }
    
        function formatProducto(producto) {
            if (producto.loading) {
                return producto.text;
            }
            var markup = `<div>${producto.nombre} - $${producto.precio}</div>`;
            return markup;
        }
    
        function formatProductoSelection(producto) {
            return producto.nombre || producto.text;
        }
    
        initSelect2();
    
        // Al añadir un nuevo producto, inicializar Select2
        $('#add-producto').on('click', function() {
            // Tu código para añadir un nuevo producto...
            // Luego, inicializa Select2 en el nuevo elemento
            initSelect2();
        });
    });
    
// JavaScript para añadir/eliminar productos dinámicamente
document.getElementById('add-producto').addEventListener('click', function() {
    const container = document.getElementById('productos-container');
    const item = container.querySelector('.producto-item').cloneNode(true);

    // Resetear los valores de los campos en el nuevo item
    item.querySelector('.producto-select').selectedIndex = 0;
    item.querySelector('.ubicacion-select').selectedIndex = 0;
    item.querySelector('.cantidad-input').value = 1;
    item.querySelector('.stock-cantidad').innerText = '-';

    container.appendChild(item);
});

// Event listener para eliminar productos
document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('remove-item')) {
        const item = e.target.closest('.producto-item');
        item.remove();
    }
});

// Event listener para actualizar el stock disponible
document.addEventListener('change', function(e) {
    if (e.target && (e.target.classList.contains('producto-select') || e.target.classList.contains('ubicacion-select'))) {
        const item = e.target.closest('.producto-item');
        const productoSelect = item.querySelector('.producto-select');
        const ubicacionSelect = item.querySelector('.ubicacion-select');
        const stockCantidad = item.querySelector('.stock-cantidad');

        const productoId = productoSelect.value;
        const ubicacionId = ubicacionSelect.value;

        if (productoId && ubicacionId) {
            fetch(`{% url 'ventas:obtener_stock' %}?producto_id=${productoId}&ubicacion_id=${ubicacionId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                stockCantidad.innerText = data.cantidad;
            })
            .catch(error => {
                console.error('Error:', error);
                stockCantidad.innerText = 'Error';
            });
        } else {
            stockCantidad.innerText = '-';
        }
    }
});
</script>
{% endblock %}
